<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½“é¨“ä¼šä¸€è¦§ãƒ»ç”³ã—è¾¼ã¿ | å…ç«¥ç™ºé”æ”¯æ´ pocopoco</title>
    <link rel="icon" type="image/png" href="images/favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Zen+Maru+Gothic:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="js/config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/style.css">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #FDFCF0; color: #4A4A4A; }
        h1, h2 { font-family: 'Zen Maru Gothic', sans-serif; }
    </style>
</head>
<body class="antialiased">

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="bg-white/90 backdrop-blur-sm fixed top-0 w-full z-40 shadow-sm border-b border-stone-200">
        <div class="max-w-md mx-auto px-4 py-3 flex justify-between items-center">
            <a href="index.html" class="font-bold text-brand-main text-xl tracking-wider font-maru hover:opacity-80 transition">
                <img src="images/logo.png" alt="pocopoco" class="h-9">
            </a>
            <a href="index.html" class="text-sm text-gray-500 hover:text-brand-main transition">
                <i class="fas fa-arrow-left mr-1"></i>TOPã¸æˆ»ã‚‹
            </a>
        </div>
    </header>

    <main class="pt-20 pb-12 px-4 max-w-md mx-auto">
        <div class="text-center mb-8">
            <h1 class="text-2xl font-bold text-brand-main mb-2">
                <i class="fas fa-calendar-alt text-brand-accent mr-2"></i>ä½“é¨“ä¼šä¸€è¦§
            </h1>
            <p class="text-sm text-gray-600">
                å¿ƒã¨ä½“ã®æˆé•·ã‚’ä¿ƒã™ã€<br>
                å½“äº‹æ¥­æ‰€ãªã‚‰ã§ã¯ã®æ”¯æ´ã‚’ä½“é¨“ã„ãŸã ã‘ã¾ã™ã€‚<br>
                æ—¥ã€…ã®é–¢ã‚ã‚Šã‚„ç™ºé”ã«ã¤ã„ã¦ã€<br>
                éŠã³ãªãŒã‚‰æ°—è»½ã«ã”ç›¸è«‡ãã ã•ã„ã€‚
            </p>
        </div>

        <!-- ä½“é¨“ä¼šä¸€è¦§ -->
        <div id="eventsList" class="space-y-4 mb-8">
            <!-- èª­ã¿è¾¼ã¿ä¸­è¡¨ç¤º -->
            <div id="loadingIndicator" class="text-center py-12">
                <i class="fas fa-spinner fa-spin text-4xl text-brand-cta mb-4"></i>
                <p class="text-gray-600 font-bold">èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
            <!-- ã‚¤ãƒ™ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ã¯JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
        </div>

        <!-- ç”³ã—è¾¼ã¿ãƒ•ã‚©ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆåˆæœŸã¯éè¡¨ç¤ºï¼‰ -->
        <div id="eventModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
                <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center">
                    <h2 class="text-xl font-bold text-brand-main">ã‚¤ãƒ™ãƒ³ãƒˆç”³ã—è¾¼ã¿</h2>
                    <button id="closeModal" class="text-gray-500 hover:text-gray-700 transition">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="eventForm" class="p-6 space-y-6">
                    <!-- é¸æŠã•ã‚ŒãŸã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ± -->
                    <div id="selectedEventInfo" class="bg-brand-light p-4 rounded-lg border border-brand-main/20">
                        <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                    </div>

                    <!-- ä¿è­·è€…æ°å -->
                    <div>
                        <label for="parentName" class="block text-sm font-bold text-gray-700 mb-1">ä¿è­·è€…æ§˜ã®ãŠåå‰ <span class="text-red-500 text-xs">*å¿…é ˆ</span></label>
                        <input type="text" id="parentName" name="parentName" required placeholder="ä¾‹ï¼šå±±ç”° èŠ±å­" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-cta focus:border-brand-cta block p-3">
                    </div>

                    <!-- ãŠå­æ§˜æ°å -->
                    <div>
                        <label for="childName" class="block text-sm font-bold text-gray-700 mb-1">ãŠå­ã•ã¾ã®ãŠåå‰ <span class="text-red-500 text-xs">*å¿…é ˆ</span></label>
                        <input type="text" id="childName" name="childName" required placeholder="ä¾‹ï¼šå±±ç”° å¤ªéƒ" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-cta focus:border-brand-cta block p-3">
                    </div>

                    <!-- å¹´é½¢ -->
                    <div>
                        <label for="childAge" class="block text-sm font-bold text-gray-700 mb-1">ãŠå­ã•ã¾ã®å¹´é½¢ <span class="text-red-500 text-xs">*å¿…é ˆ</span></label>
                        <select id="childAge" name="childAge" required class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-cta focus:border-brand-cta block p-3">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="0æ­³">0æ­³</option>
                            <option value="1æ­³">1æ­³</option>
                            <option value="2æ­³">2æ­³</option>
                            <option value="3æ­³ (å¹´å°‘)">3æ­³ (å¹´å°‘)</option>
                            <option value="4æ­³ (å¹´ä¸­)">4æ­³ (å¹´ä¸­)</option>
                            <option value="5æ­³ (å¹´é•·)">5æ­³ (å¹´é•·)</option>
                            <option value="6æ­³ (å°±å­¦å‰)">6æ­³ (å°±å­¦å‰)</option>
                        </select>
                    </div>

                    <!-- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ -->
                    <div>
                        <label for="email" class="block text-sm font-bold text-gray-700 mb-1">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ <span class="text-red-500 text-xs">*å¿…é ˆ</span></label>
                        <input type="email" id="email" name="email" required placeholder="example@email.com" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-cta focus:border-brand-cta block p-3">
                    </div>

                    <!-- é›»è©±ç•ªå· -->
                    <div>
                        <label for="tel" class="block text-sm font-bold text-gray-700 mb-1">é›»è©±ç•ªå· <span class="text-red-500 text-xs">*å¿…é ˆ</span></label>
                        <input type="tel" id="tel" name="tel" required placeholder="090-0000-0000" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-cta focus:border-brand-cta block p-3">
                    </div>

                    <!-- å‚åŠ äººæ•° -->
                    <div>
                        <label for="participants" class="block text-sm font-bold text-gray-700 mb-1">å‚åŠ äººæ•° <span class="text-red-500 text-xs">*å¿…é ˆ</span></label>
                        <select id="participants" name="participants" required class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-cta focus:border-brand-cta block p-3">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="1å">1å</option>
                            <option value="2å">2å</option>
                            <option value="3å">3å</option>
                            <option value="4åä»¥ä¸Š">4åä»¥ä¸Š</option>
                        </select>
                    </div>

                    <!-- ç™ºé”ã«ã¤ã„ã¦ã®è³ªå• -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">ãŠå­ã•ã¾ã®æˆé•·ã‚„ç™ºé”ã«ã¤ã„ã¦ã€ç¾åœ¨æ°—ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ <span class="text-red-500 text-xs">*å¿…é ˆ</span></label>
                        <div class="space-y-2">
                            <label class="flex items-center p-3 bg-gray-50 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-100 transition">
                                <input type="radio" name="developmentConcern" value="ç›¸è«‡ã—ãŸã„ã“ã¨ãŒã‚ã‚‹" required class="mr-3 text-brand-cta focus:ring-brand-cta">
                                <span class="text-sm">ç›¸è«‡ã—ãŸã„ã“ã¨ãŒã‚ã‚‹</span>
                            </label>
                            <label class="flex items-center p-3 bg-gray-50 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-100 transition">
                                <input type="radio" name="developmentConcern" value="å°‘ã—æ°—ã«ãªã£ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‚‹" required class="mr-3 text-brand-cta focus:ring-brand-cta">
                                <span class="text-sm">å°‘ã—æ°—ã«ãªã£ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‚‹</span>
                            </label>
                            <label class="flex items-center p-3 bg-gray-50 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-100 transition">
                                <input type="radio" name="developmentConcern" value="ä»Šã®ã¨ã“ã‚ç‰¹ã«ãªã—" required class="mr-3 text-brand-cta focus:ring-brand-cta">
                                <span class="text-sm">ä»Šã®ã¨ã“ã‚ç‰¹ã«ãªã—</span>
                            </label>
                        </div>
                    </div>

                    <!-- ç™ºé”ã®æ‚©ã¿è©³ç´°ï¼ˆãªã—ä»¥å¤–ã‚’é¸æŠã—ãŸå ´åˆã®ã¿è¡¨ç¤ºï¼‰ -->
                    <div id="developmentConcernDetailSection" class="hidden">
                        <label for="developmentConcernDetail" class="block text-sm font-bold text-gray-700 mb-1">è©³ç´° <span class="text-red-500 text-xs">*å¿…é ˆ</span></label>
                        <textarea id="developmentConcernDetail" name="developmentConcernDetail" rows="3" placeholder="å…·ä½“çš„ãªæ‚©ã¿ã‚„æ°—ã«ãªã‚‹ç‚¹ã‚’ç°¡æ½”ã«ã”è¨˜å…¥ãã ã•ã„" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-cta focus:border-brand-cta block p-3"></textarea>
                        <p class="text-xs text-gray-500 mt-1">â€»çŸ­æ–‡ã§ãŠé¡˜ã„ã—ã¾ã™</p>
                    </div>

                    <!-- ãã®ä»–ã”è³ªå•ãªã© -->
                    <div>
                        <label for="message" class="block text-sm font-bold text-gray-700 mb-1">ãã®ä»–ã”è³ªå•ãªã© <span class="text-gray-400 text-xs">(ä»»æ„)</span></label>
                        <textarea id="message" name="message" rows="3" placeholder="ï¼ˆä¾‹ï¼‰ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ã«ã¤ã„ã¦" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-cta focus:border-brand-cta block p-3"></textarea>
                    </div>

                    <div class="pt-4">
                        <button type="submit" id="submitBtn" class="w-full text-white bg-brand-cta hover:bg-orange-600 focus:ring-4 focus:outline-none focus:ring-orange-300 font-bold rounded-full text-lg px-5 py-4 text-center shadow-lg transition transform hover:-translate-y-1">
                            ç”³ã—è¾¼ã‚€ <i class="fas fa-paper-plane ml-2"></i>
                        </button>
                        <p class="text-center text-xs text-gray-400 mt-3">â€»å€‹äººæƒ…å ±ã¯å³é‡ã«ç®¡ç†ã—ã€ã‚¤ãƒ™ãƒ³ãƒˆå¯¾å¿œä»¥å¤–ã«ã¯ä½¿ç”¨ã„ãŸã—ã¾ã›ã‚“ã€‚</p>
                    </div>
                </form>
            </div>
        </div>

        <!-- é€ä¿¡å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ (åˆæœŸã¯éè¡¨ç¤º) -->
        <div id="successMessage" class="hidden bg-white p-8 rounded-xl shadow-md text-center">
            <div class="w-16 h-16 bg-green-100 text-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-check text-3xl"></i>
            </div>
            <h2 class="text-xl font-bold text-brand-main mb-2">ç”³ã—è¾¼ã¿å®Œäº†ã—ã¾ã—ãŸ</h2>
            <p class="text-sm text-gray-600 mb-6">
                ã‚¤ãƒ™ãƒ³ãƒˆã¸ã®ãŠç”³ã—è¾¼ã¿ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚<br>
                å†…å®¹ã‚’ç¢ºèªæ¬¡ç¬¬ã€æ‹…å½“è€…ã‚ˆã‚Šã”é€£çµ¡ã„ãŸã—ã¾ã™ã€‚
            </p>
            <div class="space-y-2">
                <button id="backToEvents" class="block w-full bg-brand-main text-white font-bold py-3 rounded-full hover:bg-brown-700 transition">
                    ä½“é¨“ä¼šä¸€è¦§ã«æˆ»ã‚‹
                </button>
                <a href="index.html" class="block w-full bg-gray-100 text-gray-700 font-bold py-3 rounded-full hover:bg-gray-200 transition">
                    TOPã¸æˆ»ã‚‹
                </a>
            </div>
        </div>
    </main>

    <script>
        // Google Apps Script URL
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwxVT5qV4GA3OHhamceSF5SSu84vJTUNFChZ_X9XELGUfwWiEoHJYMIW7MlxBop8Cdx/exec";

        let eventsData = [];
        let selectedEvent = null;

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        function loadEvents() {
            // èª­ã¿è¾¼ã¿ä¸­è¡¨ç¤ºã‚’è¡¨ç¤º
            const loadingIndicator = document.getElementById('loadingIndicator');
            if (loadingIndicator) {
                loadingIndicator.style.display = 'block';
            }
            
            fetch(SCRIPT_URL + '?action=getEvents&isArchived=false')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        eventsData = data.events || [];
                        renderEvents();
                    } else {
                        console.error('ã‚¤ãƒ™ãƒ³ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', data.message);
                        eventsData = [];
                        renderEvents();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    eventsData = [];
                    renderEvents();
                });
        }

        // æ—¥ä»˜ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatDate(dateString) {
            const date = new Date(dateString);
            const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const weekday = weekdays[date.getDay()];
            return `${month}æœˆ${day}æ—¥ï¼ˆ${weekday}ï¼‰`;
        }

        function formatTime(timeString) {
            if (!timeString) return '';
            // "10:00-14:00" å½¢å¼ã‚’ "10:00ã€œ14:00" ã«å¤‰æ›ï¼ˆæ™‚ã¯ä½¿ã‚ãªã„ï¼‰
            const parts = timeString.split('-');
            if (parts.length === 2) {
                const startTime = parts[0].trim();
                const endTime = parts[1].trim();
                return `${startTime}ã€œ${endTime}`;
            }
            return timeString;
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
        function renderEvents() {
            const eventsList = document.getElementById('eventsList');
            const loadingIndicator = document.getElementById('loadingIndicator');
            
            // èª­ã¿è¾¼ã¿ä¸­è¡¨ç¤ºã‚’éè¡¨ç¤ºã«ã™ã‚‹
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }
            
            eventsList.innerHTML = '';

            if (eventsData.length === 0) {
                eventsList.innerHTML = '<div class="text-center text-gray-500 py-8">ç¾åœ¨é–‹å‚¬äºˆå®šã®ã‚¤ãƒ™ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            // é–‹å‚¬æ—¥ã§ã‚½ãƒ¼ãƒˆï¼ˆå¤ã„é †ï¼‰
            const sortedEvents = [...eventsData].sort((a, b) => {
                return new Date(a.date) - new Date(b.date);
            });

            sortedEvents.forEach(event => {
                // ãƒ‡ãƒãƒƒã‚°: ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª
                console.log('ğŸ“ ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿:', {
                    id: event.id,
                    title: event.title,
                    imageUrl: event.imageUrl,
                    hasImageUrl: !!event.imageUrl
                });
                
                // çŠ¶æ…‹ãƒ•ãƒ©ã‚°: currentParticipantsã®å€¤ã§åˆ¤å®š
                // -1 = æ®‹ã‚Šã‚ãšã‹ã€-2 = æº€å“¡ã€0ä»¥ä¸Š = é€šå¸¸ï¼ˆå—ä»˜ä¸­ï¼‰
                const currentParticipants = event.currentParticipants || 0;
                const isFull = currentParticipants === -2;
                const isAlmostFull = currentParticipants === -1;

                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-md overflow-hidden border border-gray-200 hover:shadow-lg transition';
                
                // Base64ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‡ãƒ¼ã‚¿URIã¨ã—ã¦è¡¨ç¤ºï¼ˆGoogle Driveä¸è¦ï¼‰
                let displayImageUrl = null;
                if (event.imageUrl) {
                    let imageData = event.imageUrl;
                    
                    // Base64ãƒ‡ãƒ¼ã‚¿ã‹ã©ã†ã‹ã‚’åˆ¤å®šï¼ˆé•·ã•ãŒ100æ–‡å­—ä»¥ä¸Šã§ã€httpã§å§‹ã¾ã‚‰ãªã„ï¼‰
                    if (imageData.length > 100 && !imageData.startsWith('http')) {
                        // Base64ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‡ãƒ¼ã‚¿URIã«å¤‰æ›
                        displayImageUrl = 'data:image/jpeg;base64,' + imageData;
                        console.log('ğŸ–¼ï¸ Base64ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‡ãƒ¼ã‚¿URIã«å¤‰æ›: ' + imageData.substring(0, 50) + '...');
                    }
                    // å¾Œæ–¹äº’æ›æ€§: å¤ã„å½¢å¼ã®URLã®å ´åˆã¯ãã®ã¾ã¾ä½¿ç”¨
                    else if (imageData.indexOf('/file/d/') !== -1 || imageData.indexOf('uc?export=view&id=') !== -1 || imageData.startsWith('http')) {
                        // Google Driveã®ç”»åƒURLã‚’å¤‰æ›
                        if (imageData.indexOf('uc?export=view&id=') !== -1) {
                            displayImageUrl = imageData;
                        }
                        else if (imageData.indexOf('/file/d/') !== -1) {
                            const fileIdMatch = imageData.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
                            if (fileIdMatch && fileIdMatch[1]) {
                                displayImageUrl = 'https://drive.google.com/uc?export=view&id=' + fileIdMatch[1];
                            }
                        }
                        else {
                            displayImageUrl = imageData;
                        }
                        console.log('ğŸ–¼ï¸ å¤ã„å½¢å¼ã®URLã‚’ä½¿ç”¨ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰: ' + imageData);
                    }
                    // ãã®ä»–ã®å ´åˆã¯Base64ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦æ‰±ã†
                    else if (imageData.length > 50) {
                        displayImageUrl = 'data:image/jpeg;base64,' + imageData;
                        console.log('ğŸ–¼ï¸ Base64ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦æ‰±ã†: ' + imageData.substring(0, 50) + '...');
                    }
                }
                
                card.innerHTML = `
                    ${displayImageUrl ? `
                    <div class="w-full h-48 bg-gray-200 overflow-hidden">
                        <img src="${displayImageUrl}" alt="${event.title}" class="w-full h-full object-cover" loading="lazy" onerror="console.error('âŒ ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', this.src); this.parentElement.style.backgroundColor='#ffcccc'; this.parentElement.innerHTML='<div class=\\'w-full h-full flex items-center justify-center text-gray-500\\'>ç”»åƒã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ</div>';">
                    </div>
                    ` : ''}
                    <div class="p-5">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2 flex-wrap">
                                    <span class="bg-brand-accent text-white text-xs px-2 py-1 rounded-full font-bold">${event.category}</span>
                                    ${isFull ? '<span class="bg-red-100 text-red-600 text-xs px-2 py-1 rounded-full font-bold">æº€å“¡</span>' : ''}
                                    ${isAlmostFull && !isFull ? '<span class="bg-orange-100 text-orange-600 text-xs px-2 py-1 rounded-full font-bold">æ®‹ã‚Šã‚ãšã‹</span>' : ''}
                                </div>
                                <h3 class="text-lg font-bold text-brand-main mb-2">${event.title}</h3>
                            </div>
                        </div>
                        <div class="mb-4">
                            ${(function() {
                                const desc = event.description || '';
                                const lines = desc.split('\n');
                                const previewLines = lines.slice(0, 3);
                                const previewText = previewLines.join('\n');
                                const hasMore = lines.length > 3 || desc.length > 150;
                                // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼ˆæ”¹è¡Œã¯<br>ã«å¤‰æ›ï¼‰
                                const escapedDesc = desc.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/\n/g, '<br>');
                                const escapedPreview = previewText.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/\n/g, '<br>');
                                
                                if (hasMore) {
                                    return `
                                        <p class="text-sm text-gray-600 leading-relaxed description-text" data-full-text="${escapedDesc}">
                                            ${escapedPreview}...
                                        </p>
                                        <button class="text-xs text-brand-cta hover:text-orange-600 font-bold mt-1 description-toggle-btn" data-event-id="${event.id}">
                                            ç¶šãã‚’èª­ã‚€
                                        </button>
                                    `;
                                } else {
                                    return `<p class="text-sm text-gray-600 leading-relaxed">${escapedDesc}</p>`;
                                }
                            })()}
                        </div>
                        <div class="space-y-2 mb-4">
                            <div class="flex items-center text-sm text-gray-700">
                                <i class="fas fa-calendar-alt text-brand-cta mr-2 w-5"></i>
                                <span>${formatDate(event.date)} ${formatTime(event.time)}</span>
                            </div>
                            <div class="flex items-center text-sm text-gray-700">
                                <i class="fas fa-map-marker-alt text-brand-cta mr-2 w-5"></i>
                                <span>${event.venue || 'pocopoco æ±äº¬éƒ½åºœä¸­æ–°ç”º1ä¸ç›®71-7'}</span>
                            </div>
                            <div class="flex items-center text-sm text-gray-700">
                                <i class="fas fa-yen-sign text-brand-cta mr-2 w-5"></i>
                                <span>å‚åŠ è²»: ${event.fee || 'ç„¡æ–™'}</span>
                            </div>
                            ${event.items && event.items.trim() !== '' ? `
                            <div class="flex items-start text-sm text-gray-700">
                                <i class="fas fa-shopping-bag text-brand-cta mr-2 w-5 mt-0.5"></i>
                                <span>æŒã¡ç‰©: ${event.items}</span>
                            </div>
                            ` : ''}
                            <div class="flex items-center text-sm text-gray-700">
                                <i class="fas fa-users text-brand-cta mr-2 w-5"></i>
                                <span>å®šå“¡: ${event.capacity}å</span>
                            </div>
                        </div>
                        <button 
                            ${isFull ? 'disabled' : ''} 
                            class="w-full ${isFull ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-brand-cta text-white hover:bg-orange-600'} font-bold py-3 rounded-full transition transform ${isFull ? '' : 'hover:-translate-y-1'} event-register-btn"
                            data-event-id="${event.id}">
                            ${isFull ? 'æº€å“¡' : 'ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã«ç”³ã—è¾¼ã‚€'}
                            <i class="fas fa-chevron-right ml-2"></i>
                        </button>
                    </div>
                `;

                eventsList.appendChild(card);
            });

            // ç”³ã—è¾¼ã¿ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            document.querySelectorAll('.event-register-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const eventId = parseInt(this.dataset.eventId);
                    openEventModal(eventId);
                });
            });
            
            // ã€Œç¶šãã‚’èª­ã‚€ã€ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            document.querySelectorAll('.description-toggle-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const descriptionText = this.previousElementSibling;
                    const fullText = descriptionText.dataset.fullText;
                    
                    if (this.textContent.trim() === 'ç¶šãã‚’èª­ã‚€') {
                        // å…¨æ–‡ã‚’è¡¨ç¤ºï¼ˆHTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚’è§£é™¤ã—ã¦<br>ã‚¿ã‚°ã‚’æ”¹è¡Œã¨ã—ã¦è¡¨ç¤ºï¼‰
                        descriptionText.innerHTML = fullText;
                        this.textContent = 'é–‰ã˜ã‚‹';
                    } else {
                        // å†’é ­3è¡Œã ã‘è¡¨ç¤º
                        const lines = fullText.split('<br>');
                        const previewLines = lines.slice(0, 3);
                        const previewText = previewLines.join('<br>');
                        descriptionText.innerHTML = previewText + '...';
                        this.textContent = 'ç¶šãã‚’èª­ã‚€';
                    }
                });
            });
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openEventModal(eventId) {
            selectedEvent = eventsData.find(e => e.id === eventId);
            if (!selectedEvent) return;

            const modal = document.getElementById('eventModal');
            const selectedEventInfo = document.getElementById('selectedEventInfo');
            
            selectedEventInfo.innerHTML = `
                <h3 class="font-bold text-lg text-brand-main mb-2">${selectedEvent.title}</h3>
                <div class="space-y-1 text-sm text-gray-600">
                    <div><i class="fas fa-calendar-alt text-brand-cta mr-2"></i>${formatDate(selectedEvent.date)} ${formatTime(selectedEvent.time)}</div>
                    <div><i class="fas fa-users text-brand-cta mr-2"></i>å®šå“¡: ${selectedEvent.capacity}å</div>
                </div>
            `;

            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('eventForm').reset();
            // è©³ç´°å…¥åŠ›æ¬„ã‚’éè¡¨ç¤ºã«ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('developmentConcernDetailSection').classList.add('hidden');
            document.getElementById('developmentConcernDetail').required = false;
            
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        
        // ç™ºé”ã®æ‚©ã¿é¸æŠã«å¿œã˜ã¦è©³ç´°å…¥åŠ›æ¬„ã‚’è¡¨ç¤º/éè¡¨ç¤º
        document.addEventListener('change', function(e) {
            if (e.target.name === 'developmentConcern') {
                const detailSection = document.getElementById('developmentConcernDetailSection');
                const detailInput = document.getElementById('developmentConcernDetail');
                
                if (e.target.value === 'ä»Šã®ã¨ã“ã‚ç‰¹ã«ãªã—') {
                    detailSection.classList.add('hidden');
                    detailInput.required = false;
                    detailInput.value = ''; // å€¤ã‚’ã‚¯ãƒªã‚¢
                } else {
                    detailSection.classList.remove('hidden');
                    detailInput.required = true;
                }
            }
        });

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeEventModal() {
            const modal = document.getElementById('eventModal');
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
            selectedEvent = null;
            // è©³ç´°å…¥åŠ›æ¬„ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('developmentConcernDetailSection').classList.add('hidden');
            document.getElementById('developmentConcernDetail').required = false;
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        document.getElementById('eventModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeEventModal();
            }
        });

        // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
        document.getElementById('closeModal')?.addEventListener('click', closeEventModal);

        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
        document.getElementById('eventForm')?.addEventListener('submit', function(e) {
            e.preventDefault();

            if (!selectedEvent) {
                alert('ã‚¤ãƒ™ãƒ³ãƒˆãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }

            if (!SCRIPT_URL) {
                alert('ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã¸é€£çµ¡ï¼šGoogle Apps Scriptã®URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> é€ä¿¡ä¸­...';

            const formData = new FormData(this);
            const developmentConcern = formData.get('developmentConcern');
            const developmentConcernDetail = formData.get('developmentConcernDetail') || '';
            
            // ç™ºé”ã®æ‚©ã¿ãŒã€Œä»Šã®ã¨ã“ã‚ç‰¹ã«ãªã—ã€ä»¥å¤–ã®å ´åˆã€è©³ç´°ãŒå¿…é ˆ
            if (developmentConcern && developmentConcern !== 'ä»Šã®ã¨ã“ã‚ç‰¹ã«ãªã—' && !developmentConcernDetail.trim()) {
                alert('ç™ºé”ã®æ‚©ã¿ã®è©³ç´°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
                return;
            }
            
            const data = {
                formType: 'event',
                eventId: selectedEvent.id,
                eventTitle: selectedEvent.title,
                eventDate: selectedEvent.date,
                eventTime: selectedEvent.time,
                parentName: formData.get('parentName'),
                childName: formData.get('childName'),
                childAge: formData.get('childAge'),
                email: formData.get('email'),
                tel: formData.get('tel'),
                participants: formData.get('participants'),
                developmentConcern: developmentConcern,
                developmentConcernDetail: developmentConcern === 'ä»Šã®ã¨ã“ã‚ç‰¹ã«ãªã—' ? '' : developmentConcernDetail,
                message: formData.get('message') || ''
            };

            // GASã¸é€ä¿¡
            fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(() => {
                // æˆåŠŸæ™‚ã®å‡¦ç†
                document.getElementById('eventModal').classList.add('hidden');
                document.getElementById('eventsList').classList.add('hidden');
                document.getElementById('successMessage').classList.remove('hidden');
                document.body.style.overflow = 'auto';
                window.scrollTo(0, 0);
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            });
        });

        // ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ã«æˆ»ã‚‹
        document.getElementById('backToEvents')?.addEventListener('click', function() {
            document.getElementById('successMessage').classList.add('hidden');
            document.getElementById('eventsList').classList.remove('hidden');
            renderEvents(); // ä½“é¨“ä¼šä¸€è¦§ã‚’å†æç”»ï¼ˆæ®‹ã‚Šäººæ•°ã‚’æ›´æ–°ã™ã‚‹ãŸã‚ï¼‰
        });

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadEvents();
        });
    </script>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <footer class="bg-gray-800 text-gray-400 py-8 text-center text-xs mt-12">
        <div class="mb-4 space-x-4">
            <a href="index.html" class="hover:text-white transition">ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸</a>
            <span class="text-gray-600">|</span>
            <a href="recruit.html" class="hover:text-white transition">æ¡ç”¨æƒ…å ±</a>
            <span class="text-gray-600">|</span>
            <a href="sitter.html" class="hover:text-white transition">ãƒ™ãƒ“ãƒ¼ã‚·ãƒƒã‚¿ãƒ¼</a>
            <span class="text-gray-600">|</span>
            <a href="program.html" class="hover:text-white transition">æ”¯æ´ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãƒ»è‡ªå·±è©•ä¾¡</a>
        </div>
        <p class="mb-2">å…ç«¥ç™ºé”æ”¯æ´ pocopoco</p>
        <p class="mb-4">ã€’183-0052ã€€æ±äº¬éƒ½åºœä¸­å¸‚æ–°ç”º1ä¸ç›®71ç•ªåœ°ï¼—</p>
        <p class="mb-1">é‹å–¶ä¼šç¤¾ï¼šæ ªå¼ä¼šç¤¾INU</p>
        <p>&copy; 2025 pocopoco All Rights Reserved.</p>
    </footer>
</body>
</html>

