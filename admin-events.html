<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†ç”»é¢ | å…ç«¥ç™ºé”æ”¯æ´ pocopoco</title>
    <link rel="icon" type="image/png" href="images/favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Zen+Maru+Gothic:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="js/config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/style.css">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #FDFCF0; color: #4A4A4A; }
        h1, h2 { font-family: 'Zen Maru Gothic', sans-serif; }
        /* ãƒ–ãƒ©ãƒ³ãƒ‰ã‚«ãƒ©ãƒ¼ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ */
        .bg-brand-main { background-color: #8B5A2B !important; }
        .bg-brand-cta { background-color: #FF8F00 !important; }
        .bg-brand-accent { background-color: #7CB342 !important; }
        .text-brand-main { color: #8B5A2B !important; }
    </style>
</head>
<body class="antialiased">

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="bg-white/90 backdrop-blur-sm fixed top-0 w-full z-40 shadow-sm border-b border-stone-200">
        <div class="max-w-md mx-auto px-4 py-3 flex justify-between items-center">
            <a href="index.html" class="font-bold text-brand-main text-xl tracking-wider font-maru hover:opacity-80 transition">
                <img src="images/logo.png" alt="pocopoco" class="h-9">
            </a>
            <div class="flex gap-2">
                <a href="events.html" class="text-sm text-gray-500 hover:text-brand-main transition">
                    <i class="fas fa-calendar-alt mr-1"></i>ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§
                </a>
                <button id="logoutBtn" class="text-sm text-red-500 hover:text-red-700 transition">
                    <i class="fas fa-sign-out-alt mr-1"></i>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                </button>
            </div>
        </div>
    </header>

    <main class="pt-20 pb-12 px-4 max-w-md mx-auto">
        <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
        <div id="loginScreen" class="bg-white p-8 rounded-xl shadow-md">
            <h1 class="text-2xl font-bold text-brand-main mb-6 text-center">ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†ç”»é¢</h1>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label for="password" class="block text-sm font-bold text-gray-700 mb-1">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                    <input type="password" id="password" required class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-cta focus:border-brand-cta block p-3">
                </div>
                <button type="submit" class="w-full bg-brand-main text-white font-bold py-3 rounded-full hover:bg-brown-700 transition">
                    ãƒ­ã‚°ã‚¤ãƒ³
                </button>
            </form>
        </div>

        <!-- ç®¡ç†ç”»é¢ï¼ˆåˆæœŸã¯éè¡¨ç¤ºï¼‰ -->
        <div id="adminScreen" class="hidden">
            <div class="text-center mb-8">
                <h1 class="text-2xl font-bold text-brand-main mb-2">
                    <i class="fas fa-cog text-brand-accent mr-2"></i>ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†
                </h1>
            </div>

            <!-- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ -->
            <div class="flex gap-2 mb-6 bg-white rounded-lg p-1 shadow-sm">
                <button id="activeTab" class="flex-1 py-2 px-4 rounded-md bg-brand-main text-white font-bold text-sm transition">
                    é–‹å‚¬äºˆå®š
                </button>
                <button id="archiveTab" class="flex-1 py-2 px-4 rounded-md bg-gray-100 text-gray-700 font-bold text-sm hover:bg-gray-200 transition">
                    éå»ã®ã‚¤ãƒ™ãƒ³ãƒˆ
                </button>
            </div>

            <!-- æ–°è¦ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ ãƒœã‚¿ãƒ³ -->
            <button id="addEventBtn" class="w-full bg-brand-cta text-white font-bold py-3 rounded-full shadow-md hover:bg-orange-600 transition mb-6">
                <i class="fas fa-plus mr-2"></i>æ–°è¦ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
            </button>

            <!-- ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ -->
            <div id="eventsList" class="space-y-4">
                <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
            </div>

            <!-- ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ -->
            <div id="archivedEventsList" class="space-y-4 hidden">
                <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
            </div>
        </div>

        <!-- ã‚¤ãƒ™ãƒ³ãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="eventModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
                <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center">
                    <h2 id="modalTitle" class="text-xl font-bold text-brand-main">æ–°è¦ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ </h2>
                    <button id="closeModal" class="text-gray-500 hover:text-gray-700 transition">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="eventForm" class="p-6 space-y-6">
                    <!-- ã‚¤ãƒ™ãƒ³ãƒˆç”»åƒ -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">ã‚¤ãƒ™ãƒ³ãƒˆç”»åƒ <span class="text-gray-400 text-xs">(ä»»æ„)</span></label>
                        <div id="imagePreview" class="mb-2 hidden">
                            <img id="previewImg" src="" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" class="w-full h-48 object-cover rounded-lg border border-gray-300">
                        </div>
                        <input type="file" id="eventImage" accept="image/*" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-cta focus:border-brand-cta block p-3">
                        <p class="text-xs text-gray-500 mt-1">â€»ç”»åƒã¯è‡ªå‹•çš„ã«Google Driveã«ä¿å­˜ã•ã‚Œã¾ã™</p>
                    </div>

                    <!-- ã‚¤ãƒ™ãƒ³ãƒˆå -->
                    <div>
                        <label for="eventTitle" class="block text-sm font-bold text-gray-700 mb-1">ã‚¤ãƒ™ãƒ³ãƒˆå <span class="text-red-500 text-xs">*å¿…é ˆ</span></label>
                        <input type="text" id="eventTitle" required placeholder="ä¾‹ï¼šæœ¨è‚²ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-cta focus:border-brand-cta block p-3">
                    </div>

                    <!-- ã‚«ãƒ†ã‚´ãƒª -->
                    <div>
                        <label for="eventCategory" class="block text-sm font-bold text-gray-700 mb-1">ã‚«ãƒ†ã‚´ãƒª <span class="text-red-500 text-xs">*å¿…é ˆ</span></label>
                        <select id="eventCategory" required class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-cta focus:border-brand-cta block p-3">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="æœ¨è‚²">æœ¨è‚²</option>
                            <option value="éŸ³æ¥½">éŸ³æ¥½</option>
                            <option value="ã“ã¨ã°">ã“ã¨ã°</option>
                            <option value="é‹å‹•">é‹å‹•</option>
                            <option value="ãã®ä»–">ãã®ä»–</option>
                        </select>
                    </div>

                    <!-- èª¬æ˜ -->
                    <div>
                        <label for="eventDescription" class="block text-sm font-bold text-gray-700 mb-1">èª¬æ˜ <span class="text-red-500 text-xs">*å¿…é ˆ</span></label>
                        <textarea id="eventDescription" required rows="3" placeholder="ã‚¤ãƒ™ãƒ³ãƒˆã®è©³ç´°èª¬æ˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-cta focus:border-brand-cta block p-3"></textarea>
                    </div>

                    <!-- é–‹å‚¬æ—¥ -->
                    <div>
                        <label for="eventDate" class="block text-sm font-bold text-gray-700 mb-1">é–‹å‚¬æ—¥ <span class="text-red-500 text-xs">*å¿…é ˆ</span></label>
                        <input type="date" id="eventDate" required class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-cta focus:border-brand-cta block p-3">
                    </div>

                    <!-- é–‹å‚¬æ™‚é–“ -->
                    <div>
                        <label for="eventTime" class="block text-sm font-bold text-gray-700 mb-1">é–‹å‚¬æ™‚é–“ <span class="text-red-500 text-xs">*å¿…é ˆ</span></label>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="time" id="eventStartTime" required class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-cta focus:border-brand-cta block p-3">
                            <input type="time" id="eventEndTime" required class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-cta focus:border-brand-cta block p-3">
                        </div>
                    </div>

                    <!-- å®šå“¡ -->
                    <div>
                        <label for="eventCapacity" class="block text-sm font-bold text-gray-700 mb-1">å®šå“¡ <span class="text-red-500 text-xs">*å¿…é ˆ</span></label>
                        <input type="number" id="eventCapacity" required min="1" placeholder="ä¾‹ï¼š10" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-cta focus:border-brand-cta block p-3">
                    </div>

                    <!-- ç¾åœ¨ã®å‚åŠ è€…æ•° -->
                    <div>
                        <label for="eventCurrentParticipants" class="block text-sm font-bold text-gray-700 mb-1">ç¾åœ¨ã®å‚åŠ è€…æ•° <span class="text-gray-400 text-xs">(ä»»æ„)</span></label>
                        <input type="number" id="eventCurrentParticipants" min="0" value="0" placeholder="0" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-cta focus:border-brand-cta block p-3">
                    </div>

                    <div class="pt-4 space-y-2">
                        <button type="submit" id="submitBtn" class="w-full text-white bg-brand-cta hover:bg-orange-600 focus:ring-4 focus:outline-none focus:ring-orange-300 font-bold rounded-full text-lg px-5 py-4 text-center shadow-lg transition">
                            <i class="fas fa-save mr-2"></i>ä¿å­˜
                        </button>
                        <button type="button" id="cancelBtn" class="w-full bg-gray-100 text-gray-700 font-bold py-3 rounded-full hover:bg-gray-200 transition">
                            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <script>
        // Google Apps Script URL
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzv4fb-2jpt3xz8JrB1rs2BAWqnKt4vNIao0o3kc6lulGiY4qjB76JpTF6Yxjzi03t5/exec";
        
        // ç°¡å˜ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯ã‚ˆã‚Šå¼·å›ºãªèªè¨¼ã‚’æ¨å¥¨ï¼‰
        const ADMIN_PASSWORD = "pocopoco2025"; // å®Ÿéš›ã®é‹ç”¨ã§ã¯å¤‰æ›´ã—ã¦ãã ã•ã„
        
        let currentEditingEventId = null;
        let isArchiveMode = false;

        // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
        document.getElementById('loginForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            const password = document.getElementById('password').value;
            
            if (password === ADMIN_PASSWORD) {
                sessionStorage.setItem('adminLoggedIn', 'true');
                showAdminScreen();
            } else {
                alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚');
            }
        });

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
        document.getElementById('logoutBtn')?.addEventListener('click', function() {
            sessionStorage.removeItem('adminLoggedIn');
            location.reload();
        });

        // ç®¡ç†ç”»é¢ã‚’è¡¨ç¤º
        function showAdminScreen() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('adminScreen').classList.remove('hidden');
            loadEvents();
        }

        // åˆæœŸåŒ–æ™‚ã«ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç¢ºèª
        if (sessionStorage.getItem('adminLoggedIn') === 'true') {
            showAdminScreen();
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        document.getElementById('activeTab')?.addEventListener('click', function() {
            isArchiveMode = false;
            this.classList.add('bg-brand-main', 'text-white');
            this.classList.remove('bg-gray-100', 'text-gray-700');
            document.getElementById('archiveTab').classList.remove('bg-brand-main', 'text-white');
            document.getElementById('archiveTab').classList.add('bg-gray-100', 'text-gray-700');
            document.getElementById('eventsList').classList.remove('hidden');
            document.getElementById('archivedEventsList').classList.add('hidden');
            loadEvents();
        });

        document.getElementById('archiveTab')?.addEventListener('click', function() {
            isArchiveMode = true;
            this.classList.add('bg-brand-main', 'text-white');
            this.classList.remove('bg-gray-100', 'text-gray-700');
            document.getElementById('activeTab').classList.remove('bg-brand-main', 'text-white');
            document.getElementById('activeTab').classList.add('bg-gray-100', 'text-gray-700');
            document.getElementById('eventsList').classList.add('hidden');
            document.getElementById('archivedEventsList').classList.remove('hidden');
            loadEvents();
        });

        // ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
        function loadEvents() {
            const url = SCRIPT_URL + '?action=getEvents&isArchived=' + (isArchiveMode ? 'true' : 'false');
            console.log('ğŸ“¥ ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ã‚’å–å¾—:', url);
            
            fetch(url)
                .then(response => {
                    console.log('ğŸ“¥ ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡:', response.status, response.statusText);
                    return response.json();
                })
                .then(data => {
                    console.log('ğŸ“¥ å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿:', data);
                    if (data.status === 'success') {
                        console.log('âœ… ã‚¤ãƒ™ãƒ³ãƒˆå–å¾—æˆåŠŸ:', data.events ? data.events.length + 'ä»¶' : '0ä»¶');
                        renderEvents(data.events || [], isArchiveMode);
                    } else {
                        console.error('âŒ ã‚¤ãƒ™ãƒ³ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', data.message);
                        renderEvents([], isArchiveMode);
                    }
                })
                .catch(error => {
                    console.error('âŒ ã‚¤ãƒ™ãƒ³ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                    renderEvents([], isArchiveMode);
                });
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆã‚’æç”»
        function renderEvents(events, isArchived) {
            const container = isArchived ? document.getElementById('archivedEventsList') : document.getElementById('eventsList');
            container.innerHTML = '';

            if (events.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            events.forEach(event => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-md overflow-hidden border border-gray-200';
                
                const availableSlots = event.capacity - (event.currentParticipants || 0);
                const isFull = availableSlots <= 0;
                
                card.innerHTML = `
                    ${event.imageUrl ? `
                    <div class="w-full h-48 bg-gray-200 overflow-hidden">
                        <img src="${event.imageUrl}" alt="${event.title}" class="w-full h-full object-cover">
                    </div>
                    ` : ''}
                    <div class="p-5">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2 flex-wrap">
                                    <span class="bg-brand-accent text-white text-xs px-2 py-1 rounded-full font-bold">${event.category}</span>
                                    ${isFull ? '<span class="bg-red-100 text-red-600 text-xs px-2 py-1 rounded-full font-bold">æº€å“¡</span>' : ''}
                                    ${isArchived ? '<span class="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded-full font-bold">çµ‚äº†</span>' : ''}
                                </div>
                                <h3 class="text-lg font-bold text-brand-main mb-2">${event.title}</h3>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 mb-4 leading-relaxed">${event.description}</p>
                        <div class="space-y-2 mb-4">
                            <div class="flex items-center text-sm text-gray-700">
                                <i class="fas fa-calendar-alt text-brand-cta mr-2 w-5"></i>
                                <span>${formatDate(event.date)}</span>
                            </div>
                            <div class="flex items-center text-sm text-gray-700">
                                <i class="fas fa-clock text-brand-cta mr-2 w-5"></i>
                                <span>${event.time}</span>
                            </div>
                            <div class="flex items-center text-sm text-gray-700">
                                <i class="fas fa-users text-brand-cta mr-2 w-5"></i>
                                <span>å®šå“¡: ${event.capacity}å / å‚åŠ : ${event.currentParticipants || 0}å</span>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            ${!isArchived ? `
                            <button class="flex-1 bg-brand-main text-white font-bold py-2 rounded-lg hover:bg-brown-700 transition edit-event-btn" data-event-id="${event.id}">
                                <i class="fas fa-edit mr-1"></i>ç·¨é›†
                            </button>
                            <button class="flex-1 bg-brand-cta text-white font-bold py-2 rounded-lg hover:bg-orange-600 transition archive-event-btn" data-event-id="${event.id}">
                                <i class="fas fa-archive mr-1"></i>ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
                            </button>
                            ` : ''}
                            <button class="flex-1 bg-red-500 text-white font-bold py-2 rounded-lg hover:bg-red-600 transition delete-event-btn" data-event-id="${event.id}">
                                <i class="fas fa-trash mr-1"></i>å‰Šé™¤
                            </button>
                        </div>
                    </div>
                `;

                container.appendChild(card);
            });

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            document.querySelectorAll('.edit-event-btn').forEach(btn => {
                btn.addEventListener('click', () => editEvent(parseInt(btn.dataset.eventId)));
            });

            document.querySelectorAll('.archive-event-btn').forEach(btn => {
                btn.addEventListener('click', () => archiveEvent(parseInt(btn.dataset.eventId)));
            });

            document.querySelectorAll('.delete-event-btn').forEach(btn => {
                btn.addEventListener('click', () => deleteEvent(parseInt(btn.dataset.eventId)));
            });
        }

        // æ—¥ä»˜ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatDate(dateString) {
            const date = new Date(dateString);
            const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const weekday = weekdays[date.getDay()];
            return `${month}æœˆ${day}æ—¥ï¼ˆ${weekday}ï¼‰`;
        }

        // æ–°è¦ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ 
        document.getElementById('addEventBtn')?.addEventListener('click', function() {
            currentEditingEventId = null;
            document.getElementById('modalTitle').textContent = 'æ–°è¦ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ ';
            document.getElementById('eventForm').reset();
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('eventModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        });

        // ã‚¤ãƒ™ãƒ³ãƒˆç·¨é›†
        function editEvent(eventId) {
            fetch(SCRIPT_URL + '?action=getEvent&eventId=' + eventId)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' && data.event) {
                        const event = data.event;
                        currentEditingEventId = eventId;
                        document.getElementById('modalTitle').textContent = 'ã‚¤ãƒ™ãƒ³ãƒˆç·¨é›†';
                        document.getElementById('eventTitle').value = event.title;
                        document.getElementById('eventCategory').value = event.category;
                        document.getElementById('eventDescription').value = event.description;
                        document.getElementById('eventDate').value = event.date;
                        const [startTime, endTime] = event.time.split('-');
                        document.getElementById('eventStartTime').value = startTime.trim();
                        document.getElementById('eventEndTime').value = endTime.trim();
                        document.getElementById('eventCapacity').value = event.capacity;
                        document.getElementById('eventCurrentParticipants').value = event.currentParticipants || 0;
                        
                        if (event.imageUrl) {
                            document.getElementById('previewImg').src = event.imageUrl;
                            document.getElementById('imagePreview').classList.remove('hidden');
                        } else {
                            document.getElementById('imagePreview').classList.add('hidden');
                        }
                        
                        document.getElementById('eventModal').classList.remove('hidden');
                        document.body.style.overflow = 'hidden';
                    } else {
                        alert('ã‚¤ãƒ™ãƒ³ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('ã‚¤ãƒ™ãƒ³ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                });
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
        function archiveEvent(eventId) {
            if (!confirm('ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'archiveEvent',
                    eventId: eventId
                })
            })
            .then(() => {
                alert('ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã—ã¾ã—ãŸã€‚');
                loadEvents();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            });
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤
        function deleteEvent(eventId) {
            if (!confirm('ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) return;
            
            fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'deleteEvent',
                    eventId: eventId
                })
            })
            .then(() => {
                alert('ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
                loadEvents();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            });
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeModal() {
            document.getElementById('eventModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
            currentEditingEventId = null;
            document.getElementById('eventForm').reset();
            document.getElementById('imagePreview').classList.add('hidden');
        }

        document.getElementById('closeModal')?.addEventListener('click', closeModal);
        document.getElementById('cancelBtn')?.addEventListener('click', closeModal);

        // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        document.getElementById('eventImage')?.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('imagePreview').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
        document.getElementById('eventForm')?.addEventListener('submit', function(e) {
            e.preventDefault();

            const imageFile = document.getElementById('eventImage').files[0];
            const eventData = {
                action: currentEditingEventId ? 'updateEvent' : 'createEvent',
                eventId: currentEditingEventId,
                title: document.getElementById('eventTitle').value,
                category: document.getElementById('eventCategory').value,
                description: document.getElementById('eventDescription').value,
                date: document.getElementById('eventDate').value,
                startTime: document.getElementById('eventStartTime').value,
                endTime: document.getElementById('eventEndTime').value,
                capacity: parseInt(document.getElementById('eventCapacity').value),
                currentParticipants: parseInt(document.getElementById('eventCurrentParticipants').value) || 0
            };

            // æ™‚é–“ã‚’çµåˆ
            eventData.time = eventData.startTime + '-' + eventData.endTime;
            
            // ãƒ‡ãƒãƒƒã‚°ï¼šé€ä¿¡å‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª
            console.log('=== ğŸ“ ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‰ã®ãƒ‡ãƒ¼ã‚¿ç¢ºèª ===');
            console.log('eventData:', eventData);
            console.log('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«:', imageFile ? imageFile.name + ' (' + imageFile.size + ' bytes)' : 'ãªã—');

            const submitBtn = document.getElementById('submitBtn');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> ä¿å­˜ä¸­...';

            // ç”»åƒãŒã‚ã‚‹å ´åˆã¯Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ã¦ä¸€ç·’ã«é€ä¿¡
            if (imageFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64Data = e.target.result.split(',')[1]; // data:image/jpeg;base64, ã®éƒ¨åˆ†ã‚’é™¤å»
                    eventData.imageBase64 = base64Data;
                    eventData.imageFileName = imageFile.name;
                    saveEvent(eventData, submitBtn, originalBtnText);
                };
                reader.onerror = function() {
                    alert('ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                };
                reader.readAsDataURL(imageFile);
            } else {
                // ç”»åƒãŒãªã„å ´åˆã¯ç›´æ¥ä¿å­˜
                saveEvent(eventData, submitBtn, originalBtnText);
            }
        });

        // ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¿å­˜
        function saveEvent(eventData, submitBtn, originalBtnText) {
            console.log('=== ã‚¤ãƒ™ãƒ³ãƒˆä¿å­˜é–‹å§‹ ===');
            console.log('ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿:', JSON.stringify(eventData, null, 2));
            console.log('SCRIPT_URL:', SCRIPT_URL);
            
            // ãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼
            if (!eventData.title || !eventData.category || !eventData.date || !eventData.time) {
                alert('å¿…é ˆé …ç›®ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\n\nã‚¿ã‚¤ãƒˆãƒ«ã€ã‚«ãƒ†ã‚´ãƒªã€é–‹å‚¬æ—¥ã€é–‹å‚¬æ™‚é–“ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
                return;
            }
            
            // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’ç¢ºèª
            const requestBody = JSON.stringify(eventData);
            console.log('ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£:', requestBody);
            console.log('ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã®é•·ã•:', requestBody.length);
            
            // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¿ãƒ–ã§ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¨˜éŒ²
            console.group('ğŸ“¤ ã‚¤ãƒ™ãƒ³ãƒˆä¿å­˜ãƒªã‚¯ã‚¨ã‚¹ãƒˆ');
            console.log('URL:', SCRIPT_URL);
            console.log('Method: POST');
            console.log('Headers:', { 'Content-Type': 'application/json' });
            console.log('Body:', eventData);
            console.groupEnd();
            
            // ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡å‰ã«æœ€çµ‚ç¢ºèª
            console.log('ğŸš€ ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡é–‹å§‹');
            console.log('é€ä¿¡URL:', SCRIPT_URL);
            console.log('é€ä¿¡ãƒ‡ãƒ¼ã‚¿:', eventData);
            
            // ã¾ãšé€šå¸¸ã®CORSãƒ¢ãƒ¼ãƒ‰ã§è©¦è¡Œï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç¢ºèªã§ãã‚‹ï¼‰
            fetch(SCRIPT_URL, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json'
                },
                body: requestBody
            })
            .then(response => {
                console.log('ğŸ“¥ ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡:', response.status, response.statusText);
                return response.text().then(text => {
                    console.log('ğŸ“¥ ãƒ¬ã‚¹ãƒãƒ³ã‚¹æœ¬æ–‡:', text);
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        console.warn('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®JSONãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—:', text);
                        return { status: 'unknown', raw: text };
                    }
                });
            })
            .then(data => {
                console.log('ğŸ“¥ ãƒ‘ãƒ¼ã‚¹æ¸ˆã¿ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', data);
                if (data.status === 'success') {
                    console.log('âœ… ã‚¤ãƒ™ãƒ³ãƒˆä¿å­˜æˆåŠŸï¼');
                    alert('ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
                    closeModal();
                    loadEvents();
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                } else {
                    console.error('âŒ ä¿å­˜å¤±æ•—:', data.message || data);
                    alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nã‚¨ãƒ©ãƒ¼: ' + (data.message || JSON.stringify(data)) + '\n\nãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã¨Google Apps Scriptã®å®Ÿè¡Œãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                }
            })
            .catch(error => {
                console.error('âŒ ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', error);
                // CORSã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯no-corsãƒ¢ãƒ¼ãƒ‰ã§å†è©¦è¡Œ
                if (error.name === 'TypeError' || error.message.includes('CORS')) {
                    console.log('âš ï¸ CORSã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸãŸã‚ã€no-corsãƒ¢ãƒ¼ãƒ‰ã§å†è©¦è¡Œã—ã¾ã™');
                    fetch(SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: requestBody
                    })
                    .then(() => {
                        console.log('âœ… no-corsãƒ¢ãƒ¼ãƒ‰ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡å®Œäº†');
                        setTimeout(() => {
                            loadEvents();
                            alert('ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚\n\nâš ï¸ å®Ÿéš›ã«ä¿å­˜ã•ã‚ŒãŸã‹ç¢ºèªã—ã¦ãã ã•ã„ï¼š\n1. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ã€Œã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ã€ã‚¿ãƒ–\n2. Google Driveã®æŒ‡å®šãƒ•ã‚©ãƒ«ãƒ€\n3. Google Apps Scriptã®å®Ÿè¡Œãƒ­ã‚°');
                            closeModal();
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = originalBtnText;
                        }, 3000);
                    })
                    .catch(noCorsError => {
                        console.error('âŒ no-corsãƒ¢ãƒ¼ãƒ‰ã§ã‚‚ã‚¨ãƒ©ãƒ¼:', noCorsError);
                        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã§ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n\nã‚¨ãƒ©ãƒ¼: ' + error.message);
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalBtnText;
                    });
                } else {
                    alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã§ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n\nã‚¨ãƒ©ãƒ¼: ' + error.message);
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                }
            });
        }
    </script>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <footer class="bg-gray-800 text-gray-400 py-8 text-center text-xs mt-12">
        <p>&copy; 2025 pocopoco All Rights Reserved.</p>
    </footer>
</body>
</html>

