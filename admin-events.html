<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½“é¨“ä¼šç®¡ç†ç”»é¢ | å…ç«¥ç™ºé”æ”¯æ´ pocopoco</title>
    <link rel="icon" type="image/png" href="images/favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Zen+Maru+Gothic:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="js/config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/style.css">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #FDFCF0; color: #4A4A4A; }
        h1, h2 { font-family: 'Zen Maru Gothic', sans-serif; }
        /* Flatpickrã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®èƒŒæ™¯ã‚’ä¸é€æ˜ã«ã™ã‚‹ï¼ˆã‚¹ãƒãƒ›å¯¾å¿œï¼‰ */
        .flatpickr-calendar {
            background: white !important;
            opacity: 1 !important;
            box-shadow: 0 3px 13px rgba(0, 0, 0, 0.2) !important;
        }
        .flatpickr-months {
            background: white !important;
        }
        .flatpickr-weekdays {
            background: white !important;
        }
        .flatpickr-days {
            background: white !important;
        }
        .flatpickr-time {
            background: white !important;
        }
        /* ãƒ–ãƒ©ãƒ³ãƒ‰ã‚«ãƒ©ãƒ¼ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ */
        .bg-brand-main { background-color: #8B5A2B !important; }
        .bg-brand-cta { background-color: #FF8F00 !important; }
        .bg-brand-accent { background-color: #7CB342 !important; }
        .text-brand-main { color: #8B5A2B !important; }
    </style>
</head>
<body class="antialiased">

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="bg-white/90 backdrop-blur-sm fixed top-0 w-full z-40 shadow-sm border-b border-stone-200">
        <div class="max-w-md mx-auto px-4 py-3 flex justify-between items-center">
            <a href="index.html" class="font-bold text-brand-main text-xl tracking-wider font-maru hover:opacity-80 transition">
                <img src="images/logo.png" alt="pocopoco" class="h-9">
            </a>
            <div class="flex gap-2">
                <a href="events.html" class="text-sm text-gray-500 hover:text-brand-main transition">
                    <i class="fas fa-calendar-alt mr-1"></i>ä½“é¨“ä¼šä¸€è¦§
                </a>
                <button id="logoutBtn" class="text-sm text-red-500 hover:text-red-700 transition">
                    <i class="fas fa-sign-out-alt mr-1"></i>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                </button>
            </div>
        </div>
    </header>

    <main class="pt-20 pb-12 px-4 max-w-md mx-auto">
        <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
        <div id="loginScreen" class="bg-white p-8 rounded-xl shadow-md">
            <h1 class="text-2xl font-bold text-brand-main mb-6 text-center">ä½“é¨“ä¼šç®¡ç†ç”»é¢</h1>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label for="password" class="block text-sm font-bold text-gray-700 mb-1">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                    <input type="password" id="password" required class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-cta focus:border-brand-cta block p-3">
                </div>
                <button type="submit" class="w-full bg-brand-main text-white font-bold py-3 rounded-full hover:bg-brown-700 transition">
                    ãƒ­ã‚°ã‚¤ãƒ³
                </button>
            </form>
        </div>

        <!-- ç®¡ç†ç”»é¢ï¼ˆåˆæœŸã¯éè¡¨ç¤ºï¼‰ -->
        <div id="adminScreen" class="hidden">
            <div class="text-center mb-8">
                <h1 class="text-2xl font-bold text-brand-main mb-2">
                    <i class="fas fa-cog text-brand-accent mr-2"></i>ä½“é¨“ä¼šç®¡ç†
                </h1>
            </div>

            <!-- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ -->
            <div class="flex gap-2 mb-6 bg-white rounded-lg p-1 shadow-sm">
                <button id="activeTab" class="flex-1 py-2 px-4 rounded-md bg-brand-main text-white font-bold text-sm transition">
                    é–‹å‚¬äºˆå®š
                </button>
                <button id="archiveTab" class="flex-1 py-2 px-4 rounded-md bg-gray-100 text-gray-700 font-bold text-sm hover:bg-gray-200 transition">
                    éå»ã®ä½“é¨“ä¼š
                </button>
            </div>

            <!-- æ–°è¦ä½“é¨“ä¼šè¿½åŠ ãƒœã‚¿ãƒ³ -->
            <button id="addEventBtn" class="w-full bg-brand-cta text-white font-bold py-3 rounded-full shadow-md hover:bg-orange-600 transition mb-6">
                <i class="fas fa-plus mr-2"></i>æ–°è¦ä½“é¨“ä¼šã‚’è¿½åŠ 
            </button>

            <!-- ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ -->
            <div id="eventsList" class="space-y-4">
                <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
            </div>

            <!-- ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ -->
            <div id="archivedEventsList" class="space-y-4 hidden">
                <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
            </div>
        </div>

        <!-- ä½“é¨“ä¼šç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="eventModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
                <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center">
                    <h2 id="modalTitle" class="text-xl font-bold text-brand-main">æ–°è¦ä½“é¨“ä¼šè¿½åŠ </h2>
                    <button id="closeModal" class="text-gray-500 hover:text-gray-700 transition">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="eventForm" class="p-6 space-y-6">
                    <!-- ã‚¤ãƒ™ãƒ³ãƒˆç”»åƒ -->
                    <div id="imageUploadSection" style="display: block !important;">
                        <label for="eventImage" class="block text-sm font-bold text-gray-700 mb-1">ã‚¤ãƒ™ãƒ³ãƒˆç”»åƒ <span class="text-gray-400 text-xs">(ä»»æ„)</span></label>
                        <div id="imagePreview" class="mb-2 hidden">
                            <img id="previewImg" src="" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" class="w-full h-48 object-cover rounded-lg border border-gray-300 mb-2">
                            <button id="reCropBtn" type="button" class="w-full px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition font-bold text-sm">
                                <i class="fas fa-crop mr-2"></i>ç¯„å›²ã‚’ä¿®æ­£ã™ã‚‹
                            </button>
                        </div>
                        <input type="file" id="eventImage" name="eventImage" accept="image/*" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-cta focus:border-brand-cta block p-3" style="display: block !important; visibility: visible !important;">
                        <p class="text-xs text-gray-500 mt-1">â€»ç”»åƒã‚’é¸æŠã™ã‚‹ã¨ãƒˆãƒªãƒŸãƒ³ã‚°ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
                    </div>

                    <!-- ã‚¤ãƒ™ãƒ³ãƒˆå -->
                    <div>
                        <label for="eventTitle" class="block text-sm font-bold text-gray-700 mb-1">ã‚¤ãƒ™ãƒ³ãƒˆå <span class="text-red-500 text-xs">*å¿…é ˆ</span></label>
                        <input type="text" id="eventTitle" required placeholder="ä¾‹ï¼šæœ¨è‚²ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-cta focus:border-brand-cta block p-3">
                    </div>

                    <!-- ã‚«ãƒ†ã‚´ãƒª -->
                    <div>
                        <label for="eventCategory" class="block text-sm font-bold text-gray-700 mb-1">ã‚«ãƒ†ã‚´ãƒª <span class="text-red-500 text-xs">*å¿…é ˆ</span></label>
                        <select id="eventCategory" required class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-cta focus:border-brand-cta block p-3">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="æœ¨è‚²">æœ¨è‚²</option>
                            <option value="éŸ³æ¥½">éŸ³æ¥½</option>
                            <option value="ã“ã¨ã°">ã“ã¨ã°</option>
                            <option value="é‹å‹•">é‹å‹•</option>
                            <option value="ãã®ä»–">ãã®ä»–</option>
                        </select>
                    </div>

                    <!-- èª¬æ˜ -->
                    <div>
                        <label for="eventDescription" class="block text-sm font-bold text-gray-700 mb-1">èª¬æ˜ <span class="text-red-500 text-xs">*å¿…é ˆ</span></label>
                        <textarea id="eventDescription" required rows="3" placeholder="ã‚¤ãƒ™ãƒ³ãƒˆã®è©³ç´°èª¬æ˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-cta focus:border-brand-cta block p-3"></textarea>
                    </div>

                    <!-- é–‹å‚¬æ—¥æ™‚ -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">é–‹å‚¬æ—¥æ™‚ <span class="text-red-500 text-xs">*å¿…é ˆ</span></label>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">é–‹å§‹æ—¥æ™‚</label>
                                <input type="text" id="eventStartDateTime" required class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-cta focus:border-brand-cta block p-3" placeholder="é–‹å§‹æ—¥æ™‚ã‚’é¸æŠ" readonly>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">çµ‚äº†æ—¥æ™‚</label>
                                <input type="text" id="eventEndDateTime" required class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-cta focus:border-brand-cta block p-3" placeholder="çµ‚äº†æ—¥æ™‚ã‚’é¸æŠ" readonly>
                            </div>
                        </div>
                        <!-- éè¡¨ç¤ºãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ï¼‰ -->
                        <input type="hidden" id="eventDate">
                        <input type="hidden" id="eventStartTime">
                        <input type="hidden" id="eventEndTime">
                        <p class="text-xs text-gray-500 mt-1">â€»æ—¥æ™‚ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¨æ™‚åˆ»é¸æŠãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
                    </div>


                    <!-- å®šå“¡ -->
                    <div>
                        <label for="eventCapacity" class="block text-sm font-bold text-gray-700 mb-1">å®šå“¡ <span class="text-red-500 text-xs">*å¿…é ˆ</span></label>
                        <input type="number" id="eventCapacity" required min="1" placeholder="ä¾‹ï¼š10" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-cta focus:border-brand-cta block p-3">
                    </div>

                    <!-- ç¾åœ¨ã®å‚åŠ è€…æ•° -->
                    <div>
                        <label for="eventCurrentParticipants" class="block text-sm font-bold text-gray-700 mb-1">ç¾åœ¨ã®å‚åŠ è€…æ•° <span class="text-gray-400 text-xs">(ä»»æ„)</span></label>
                        <input type="number" id="eventCurrentParticipants" min="0" value="0" placeholder="0" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-cta focus:border-brand-cta block p-3">
                    </div>

                    <!-- ä¼šå ´ -->
                    <div>
                        <label for="eventVenue" class="block text-sm font-bold text-gray-700 mb-1">ä¼šå ´ <span class="text-red-500 text-xs">*å¿…é ˆ</span></label>
                        <input type="text" id="eventVenue" required value="pocopoco æ±äº¬éƒ½åºœä¸­æ–°ç”º1ä¸ç›®71-7" placeholder="ä¼šå ´ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-cta focus:border-brand-cta block p-3">
                    </div>

                    <!-- å‚åŠ è²» -->
                    <div>
                        <label for="eventFee" class="block text-sm font-bold text-gray-700 mb-1">å‚åŠ è²» <span class="text-red-500 text-xs">*å¿…é ˆ</span></label>
                        <input type="text" id="eventFee" required value="ç„¡æ–™" placeholder="å‚åŠ è²»ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šç„¡æ–™ã€500å††ãªã©ï¼‰" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-cta focus:border-brand-cta block p-3">
                    </div>

                    <!-- æŒã¡ç‰© -->
                    <div>
                        <label for="eventItems" class="block text-sm font-bold text-gray-700 mb-1">æŒã¡ç‰© <span class="text-gray-400 text-xs">(ä»»æ„)</span></label>
                        <input type="text" id="eventItems" placeholder="æŒã¡ç‰©ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šç­†è¨˜ç”¨å…·ã€ã‚¿ã‚ªãƒ«ãªã©ï¼‰" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-cta focus:border-brand-cta block p-3">
                    </div>

                    <!-- ç™»éŒ²è€… -->
                    <div>
                        <label for="eventRegistrant" class="block text-sm font-bold text-gray-700 mb-1">ç™»éŒ²è€… <span class="text-red-500 text-xs">*å¿…é ˆ</span></label>
                        <select id="eventRegistrant" required class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-cta focus:border-brand-cta block p-3">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="ç• æ˜‚å“‰">ç• æ˜‚å“‰</option>
                            <option value="é…’äº•ãã‚‹ã¿">é…’äº•ãã‚‹ã¿</option>
                            <option value="å¹³äº•èœå¤®">å¹³äº•èœå¤®</option>
                            <option value="æ°´çŸ³æ™¶å­">æ°´çŸ³æ™¶å­</option>
                            <option value="é•·å°¾éº»ç”±å­">é•·å°¾éº»ç”±å­</option>
                            <option value="ç• çœŸå§«">ç• çœŸå§«</option>
                        </select>
                    </div>

                    <div class="pt-4 space-y-2">
                        <button type="submit" id="submitBtn" class="w-full text-white bg-brand-cta hover:bg-orange-600 focus:ring-4 focus:outline-none focus:ring-orange-300 font-bold rounded-full text-lg px-5 py-4 text-center shadow-lg transition">
                            <i class="fas fa-save mr-2"></i>ä¿å­˜
                        </button>
                        <button type="button" id="cancelBtn" class="w-full bg-gray-100 text-gray-700 font-bold py-3 rounded-full hover:bg-gray-200 transition">
                            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <script>
        // Google Apps Script URL
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxF3QXoAfDH4EuGgQZMsmhPZMoIHcesFXTV3RD1nj7oMWjmr7RL53jCB_JBMbRqDhpk/exec";
        
        // ç°¡å˜ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯ã‚ˆã‚Šå¼·å›ºãªèªè¨¼ã‚’æ¨å¥¨ï¼‰
        const ADMIN_PASSWORD = "pocopoco2025"; // å®Ÿéš›ã®é‹ç”¨ã§ã¯å¤‰æ›´ã—ã¦ãã ã•ã„
        
        let currentEditingEventId = null;
        let isArchiveMode = false;

        // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
        document.getElementById('loginForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            const password = document.getElementById('password').value;
            
            // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯å‰Šé™¤æ¨å¥¨ï¼‰
            console.log('å…¥åŠ›ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®é•·ã•:', password.length);
            console.log('è¨­å®šã•ã‚Œã¦ã„ã‚‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®é•·ã•:', ADMIN_PASSWORD.length);
            
            // å‰å¾Œã®ç©ºç™½ã‚’å‰Šé™¤ã—ã¦æ¯”è¼ƒ
            const trimmedPassword = password.trim();
            
            if (trimmedPassword === ADMIN_PASSWORD) {
                sessionStorage.setItem('adminLoggedIn', 'true');
                showAdminScreen();
            } else {
                alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚\n\næ­£ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
                document.getElementById('password').value = '';
            }
        });

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
        document.getElementById('logoutBtn')?.addEventListener('click', function() {
            sessionStorage.removeItem('adminLoggedIn');
            location.reload();
        });

        // ç®¡ç†ç”»é¢ã‚’è¡¨ç¤º
        function showAdminScreen() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('adminScreen').classList.remove('hidden');
            loadEvents();
        }

        // åˆæœŸåŒ–æ™‚ã«ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç¢ºèª
        if (sessionStorage.getItem('adminLoggedIn') === 'true') {
            showAdminScreen();
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        document.getElementById('activeTab')?.addEventListener('click', function() {
            isArchiveMode = false;
            this.classList.add('bg-brand-main', 'text-white');
            this.classList.remove('bg-gray-100', 'text-gray-700');
            document.getElementById('archiveTab').classList.remove('bg-brand-main', 'text-white');
            document.getElementById('archiveTab').classList.add('bg-gray-100', 'text-gray-700');
            document.getElementById('eventsList').classList.remove('hidden');
            document.getElementById('archivedEventsList').classList.add('hidden');
            loadEvents();
        });

        document.getElementById('archiveTab')?.addEventListener('click', function() {
            isArchiveMode = true;
            this.classList.add('bg-brand-main', 'text-white');
            this.classList.remove('bg-gray-100', 'text-gray-700');
            document.getElementById('activeTab').classList.remove('bg-brand-main', 'text-white');
            document.getElementById('activeTab').classList.add('bg-gray-100', 'text-gray-700');
            document.getElementById('eventsList').classList.add('hidden');
            document.getElementById('archivedEventsList').classList.remove('hidden');
            loadEvents();
        });

        // ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
        function loadEvents() {
            const url = SCRIPT_URL + '?action=getEvents&isArchived=' + (isArchiveMode ? 'true' : 'false');
            console.log('ğŸ“¥ ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ã‚’å–å¾—:', url);
            
            fetch(url)
                .then(response => {
                    console.log('ğŸ“¥ ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡:', response.status, response.statusText);
                    return response.json();
                })
                .then(data => {
                    console.log('ğŸ“¥ å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿:', data);
                    if (data.status === 'success') {
                        console.log('âœ… ã‚¤ãƒ™ãƒ³ãƒˆå–å¾—æˆåŠŸ:', data.events ? data.events.length + 'ä»¶' : '0ä»¶');
                        renderEvents(data.events || [], isArchiveMode);
                    } else {
                        console.error('âŒ ã‚¤ãƒ™ãƒ³ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', data.message);
                        renderEvents([], isArchiveMode);
                    }
                })
                .catch(error => {
                    console.error('âŒ ã‚¤ãƒ™ãƒ³ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                    renderEvents([], isArchiveMode);
                });
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆã‚’æç”»
        function renderEvents(events, isArchived) {
            const container = isArchived ? document.getElementById('archivedEventsList') : document.getElementById('eventsList');
            container.innerHTML = '';

            if (events.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">ä½“é¨“ä¼šãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            events.forEach(event => {
                // ãƒ‡ãƒãƒƒã‚°: ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª
                console.log('ğŸ“ ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿:', {
                    id: event.id,
                    title: event.title,
                    imageUrl: event.imageUrl,
                    imageUrlType: typeof event.imageUrl,
                    hasImageUrl: !!event.imageUrl,
                    imageUrlLength: event.imageUrl ? event.imageUrl.length : 0
                });
                
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-md overflow-hidden border border-gray-200';
                
                // çŠ¶æ…‹ãƒ•ãƒ©ã‚°: currentParticipantsã®å€¤ã§åˆ¤å®š
                // -1 = æ®‹ã‚Šã‚ãšã‹ã€-2 = æº€å“¡ã€0ä»¥ä¸Š = é€šå¸¸ï¼ˆå—ä»˜ä¸­ï¼‰
                const currentParticipants = event.currentParticipants || 0;
                const isFull = currentParticipants === -2;
                const isAlmostFull = currentParticipants === -1;
                
                // Base64ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‡ãƒ¼ã‚¿URIã¨ã—ã¦è¡¨ç¤ºï¼ˆGoogle Driveä¸è¦ï¼‰
                let displayImageUrl = null;
                if (event.imageUrl) {
                    let imageData = event.imageUrl;
                    
                    // Base64ãƒ‡ãƒ¼ã‚¿ã‹ã©ã†ã‹ã‚’åˆ¤å®šï¼ˆé•·ã•ãŒ100æ–‡å­—ä»¥ä¸Šã§ã€httpã§å§‹ã¾ã‚‰ãªã„ï¼‰
                    if (imageData.length > 100 && !imageData.startsWith('http')) {
                        // Base64ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‡ãƒ¼ã‚¿URIã«å¤‰æ›
                        displayImageUrl = 'data:image/jpeg;base64,' + imageData;
                        console.log('ğŸ–¼ï¸ Base64ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‡ãƒ¼ã‚¿URIã«å¤‰æ›: ' + imageData.substring(0, 50) + '...');
                    }
                    // å¾Œæ–¹äº’æ›æ€§: å¤ã„å½¢å¼ã®URLã®å ´åˆã¯ãã®ã¾ã¾ä½¿ç”¨
                    else if (imageData.indexOf('/file/d/') !== -1 || imageData.indexOf('uc?export=view&id=') !== -1 || imageData.startsWith('http')) {
                        // Google Driveã®ç”»åƒURLã‚’å¤‰æ›
                        if (imageData.indexOf('uc?export=view&id=') !== -1) {
                            displayImageUrl = imageData;
                        }
                        else if (imageData.indexOf('/file/d/') !== -1) {
                            const fileIdMatch = imageData.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
                            if (fileIdMatch && fileIdMatch[1]) {
                                displayImageUrl = 'https://drive.google.com/uc?export=view&id=' + fileIdMatch[1];
                            }
                        }
                        else {
                            displayImageUrl = imageData;
                        }
                        console.log('ğŸ–¼ï¸ å¤ã„å½¢å¼ã®URLã‚’ä½¿ç”¨ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰: ' + imageData);
                    }
                    // ãã®ä»–ã®å ´åˆã¯Base64ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦æ‰±ã†
                    else if (imageData.length > 50) {
                        displayImageUrl = 'data:image/jpeg;base64,' + imageData;
                        console.log('ğŸ–¼ï¸ Base64ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦æ‰±ã†: ' + imageData.substring(0, 50) + '...');
                    }
                }
                
                card.innerHTML = `
                    ${displayImageUrl ? `
                    <div class="w-full h-48 bg-gray-200 overflow-hidden">
                        <img src="${displayImageUrl}" alt="${event.title}" class="w-full h-full object-cover" onerror="console.error('âŒ ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', this.src); this.parentElement.style.backgroundColor='#ffcccc'; this.parentElement.innerHTML='<div class=\\'w-full h-full flex items-center justify-center text-gray-500\\'>ç”»åƒã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ</div>';">
                    </div>
                    ` : ''}
                    <div class="p-5">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2 flex-wrap">
                                    <span class="bg-brand-accent text-white text-xs px-2 py-1 rounded-full font-bold">${event.category}</span>
                                    ${isFull ? '<span class="bg-red-100 text-red-600 text-xs px-2 py-1 rounded-full font-bold">æº€å“¡</span>' : ''}
                                    ${isAlmostFull && !isFull ? '<span class="bg-orange-100 text-orange-600 text-xs px-2 py-1 rounded-full font-bold">æ®‹ã‚Šã‚ãšã‹</span>' : ''}
                                    ${isArchived ? '<span class="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded-full font-bold">çµ‚äº†</span>' : ''}
                                </div>
                                <h3 class="text-lg font-bold text-brand-main mb-2">${event.title}</h3>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 mb-4 leading-relaxed">${event.description}</p>
                        <div class="space-y-2 mb-4">
                            <div class="flex items-center text-sm text-gray-700">
                                <i class="fas fa-calendar-alt text-brand-cta mr-2 w-5"></i>
                                <span>${formatDate(event.date)} ${formatTime(event.time)}</span>
                            </div>
                            <div class="flex items-center text-sm text-gray-700">
                                <i class="fas fa-map-marker-alt text-brand-cta mr-2 w-5"></i>
                                <span>${event.venue || 'pocopoco æ±äº¬éƒ½åºœä¸­æ–°ç”º1ä¸ç›®71-7'}</span>
                            </div>
                            <div class="flex items-center text-sm text-gray-700">
                                <i class="fas fa-yen-sign text-brand-cta mr-2 w-5"></i>
                                <span>å‚åŠ è²»: ${event.fee || 'ç„¡æ–™'}</span>
                            </div>
                            ${event.items && event.items.trim() !== '' ? `
                            <div class="flex items-start text-sm text-gray-700">
                                <i class="fas fa-shopping-bag text-brand-cta mr-2 w-5 mt-0.5"></i>
                                <span>æŒã¡ç‰©: ${event.items}</span>
                            </div>
                            ` : ''}
                            <div class="flex items-center text-sm text-gray-700">
                                <i class="fas fa-users text-brand-cta mr-2 w-5"></i>
                                <span>å®šå“¡: ${event.capacity}å / å‚åŠ : ${(event.currentParticipants !== null && event.currentParticipants !== undefined) ? event.currentParticipants : 0}å</span>
                            </div>
                        </div>
                        <div class="flex flex-col gap-2">
                            ${!isArchived ? `
                            <div class="flex gap-2">
                                <button class="flex-1 bg-brand-main text-white font-bold py-2 rounded-lg hover:bg-brown-700 transition edit-event-btn" data-event-id="${event.id}">
                                    <i class="fas fa-edit mr-1"></i>ç·¨é›†
                                </button>
                                <button class="flex-1 bg-brand-cta text-white font-bold py-2 rounded-lg hover:bg-orange-600 transition archive-event-btn" data-event-id="${event.id}">
                                    <i class="fas fa-archive mr-1"></i>ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
                                </button>
                            </div>
                            <div class="flex gap-2">
                                ${!isFull ? `
                                <button class="flex-1 bg-orange-500 text-white font-bold py-2 rounded-lg hover:bg-orange-600 transition set-almost-full-btn" data-event-id="${event.id}">
                                    <i class="fas fa-exclamation-triangle mr-1"></i>æ®‹ã‚Šã‚ãšã‹
                                </button>
                                <button class="flex-1 bg-red-500 text-white font-bold py-2 rounded-lg hover:bg-red-600 transition set-full-btn" data-event-id="${event.id}">
                                    <i class="fas fa-ban mr-1"></i>æº€å“¡ã«ã™ã‚‹
                                </button>
                                ` : `
                                <button class="flex-1 bg-green-500 text-white font-bold py-2 rounded-lg hover:bg-green-600 transition reopen-registration-btn" data-event-id="${event.id}">
                                    <i class="fas fa-unlock mr-1"></i>å—ä»˜å†é–‹
                                </button>
                                `}
                            </div>
                            ` : ''}
                            <button class="w-full bg-red-500 text-white font-bold py-2 rounded-lg hover:bg-red-600 transition delete-event-btn" data-event-id="${event.id}">
                                <i class="fas fa-trash mr-1"></i>å‰Šé™¤
                            </button>
                        </div>
                    </div>
                `;

                container.appendChild(card);
            });

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            document.querySelectorAll('.edit-event-btn').forEach(btn => {
                btn.addEventListener('click', () => editEvent(parseInt(btn.dataset.eventId)));
            });

            document.querySelectorAll('.archive-event-btn').forEach(btn => {
                btn.addEventListener('click', () => archiveEvent(parseInt(btn.dataset.eventId)));
            });

            document.querySelectorAll('.delete-event-btn').forEach(btn => {
                btn.addEventListener('click', () => deleteEvent(parseInt(btn.dataset.eventId)));
            });
            
            // ã€Œæ®‹ã‚Šã‚ãšã‹ã€ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            document.querySelectorAll('.set-almost-full-btn').forEach(btn => {
                btn.addEventListener('click', () => setAlmostFull(parseInt(btn.dataset.eventId)));
            });
            
            // ã€Œæº€å“¡ã«ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            document.querySelectorAll('.set-full-btn').forEach(btn => {
                btn.addEventListener('click', () => setFull(parseInt(btn.dataset.eventId)));
            });
            
            // ã€Œå—ä»˜å†é–‹ã€ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            document.querySelectorAll('.reopen-registration-btn').forEach(btn => {
                btn.addEventListener('click', () => reopenRegistration(parseInt(btn.dataset.eventId)));
            });
        }
        
        // æ®‹ã‚Šã‚ãšã‹ã«è¨­å®š
        function setAlmostFull(eventId) {
            if (!confirm('ã“ã®ä½“é¨“ä¼šã‚’ã€Œæ®‹ã‚Šã‚ãšã‹ã€ã«è¨­å®šã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            console.log('ğŸ”„ æ®‹ã‚Šã‚ãšã‹è¨­å®šé–‹å§‹: eventId =', eventId);
            
            // CORSã‚¨ãƒ©ãƒ¼ã‚’å›é¿ã™ã‚‹ãŸã‚ã€URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦é€ä¿¡
            const url = SCRIPT_URL + '?action=setAlmostFull&eventId=' + eventId;
            fetch(url, {
                method: 'GET',
                mode: 'no-cors'
            })
            .then(function() {
                // no-corsãƒ¢ãƒ¼ãƒ‰ã§ã¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’èª­ã‚ãªã„ãŸã‚ã€æˆåŠŸã¨ã¿ãªã™
                alert('ã€Œæ®‹ã‚Šã‚ãšã‹ã€ã«è¨­å®šã—ã¾ã—ãŸã€‚');
                loadEvents();
            })
            .catch(function(error) {
                console.error('âŒ æ®‹ã‚Šã‚ãšã‹è¨­å®šã‚¨ãƒ©ãƒ¼:', error);
                alert('è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nã‚¨ãƒ©ãƒ¼: ' + error.message + '\n\nãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            });
        }
        
        // æº€å“¡ã«è¨­å®š
        function setFull(eventId) {
            if (!confirm('ã“ã®ä½“é¨“ä¼šã‚’ã€Œæº€å“¡ã€ã«è¨­å®šã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆç”³ã—è¾¼ã¿å—ä»˜ã‚’çµ‚äº†ã—ã¾ã™ï¼‰')) return;
            
            console.log('ğŸ”„ æº€å“¡è¨­å®šé–‹å§‹: eventId =', eventId);
            
            // CORSã‚¨ãƒ©ãƒ¼ã‚’å›é¿ã™ã‚‹ãŸã‚ã€URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦é€ä¿¡
            const url = SCRIPT_URL + '?action=setFull&eventId=' + eventId;
            fetch(url, {
                method: 'GET',
                mode: 'no-cors'
            })
            .then(() => {
                // no-corsãƒ¢ãƒ¼ãƒ‰ã§ã¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’èª­ã‚ãªã„ãŸã‚ã€æˆåŠŸã¨ã¿ãªã™
                alert('ã€Œæº€å“¡ã€ã«è¨­å®šã—ã¾ã—ãŸã€‚ç”³ã—è¾¼ã¿å—ä»˜ã‚’çµ‚äº†ã—ã¾ã—ãŸã€‚');
                loadEvents();
            })
            .catch(error => {
                console.error('âŒ æº€å“¡è¨­å®šã‚¨ãƒ©ãƒ¼:', error);
                alert('è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nã‚¨ãƒ©ãƒ¼: ' + error.message + '\n\nãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            });
        }
        
        // å—ä»˜å†é–‹
        function reopenRegistration(eventId) {
            if (!confirm('ã“ã®ä½“é¨“ä¼šã®ç”³ã—è¾¼ã¿å—ä»˜ã‚’å†é–‹ã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            console.log('ğŸ”„ å—ä»˜å†é–‹é–‹å§‹: eventId =', eventId);
            
            // CORSã‚¨ãƒ©ãƒ¼ã‚’å›é¿ã™ã‚‹ãŸã‚ã€URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦é€ä¿¡
            const url = SCRIPT_URL + '?action=reopenRegistration&eventId=' + eventId;
            fetch(url, {
                method: 'GET',
                mode: 'no-cors'
            })
            .then(() => {
                // no-corsãƒ¢ãƒ¼ãƒ‰ã§ã¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’èª­ã‚ãªã„ãŸã‚ã€æˆåŠŸã¨ã¿ãªã™
                alert('ç”³ã—è¾¼ã¿å—ä»˜ã‚’å†é–‹ã—ã¾ã—ãŸã€‚');
                loadEvents();
            })
            .catch(error => {
                console.error('âŒ å—ä»˜å†é–‹ã‚¨ãƒ©ãƒ¼:', error);
                alert('è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nã‚¨ãƒ©ãƒ¼: ' + error.message + '\n\nãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            });
        }

        // æ—¥ä»˜ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatDate(dateString) {
            const date = new Date(dateString);
            const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const weekday = weekdays[date.getDay()];
            return `${month}æœˆ${day}æ—¥ï¼ˆ${weekday}ï¼‰`;
        }

        function formatTime(timeString) {
            if (!timeString) return '';
            // "10:00-14:00" å½¢å¼ã‚’ "10:00ã€œ14:00" ã«å¤‰æ›ï¼ˆæ™‚ã¯ä½¿ã‚ãªã„ï¼‰
            const parts = timeString.split('-');
            if (parts.length === 2) {
                const startTime = parts[0].trim();
                const endTime = parts[1].trim();
                return `${startTime}ã€œ${endTime}`;
            }
            return timeString;
        }

        // æ–°è¦ä½“é¨“ä¼šè¿½åŠ 
        document.getElementById('addEventBtn')?.addEventListener('click', function() {
            currentEditingEventId = null;
            document.getElementById('modalTitle').textContent = 'æ–°è¦ä½“é¨“ä¼šè¿½åŠ ';
            // æ–°è¦è¿½åŠ æ™‚ã¯ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ã€Œä¿å­˜ã€ã«æˆ»ã™
            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn) {
                submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i>ä¿å­˜';
            }
            document.getElementById('eventForm').reset();
            document.getElementById('imagePreview').classList.add('hidden');
            // ç”»åƒå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç¢ºå®Ÿã«è¡¨ç¤º
            const imageInput = document.getElementById('eventImage');
            if (imageInput) {
                imageInput.style.display = 'block';
                imageInput.value = ''; // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
            }
            const imageUploadSection = document.getElementById('imageUploadSection');
            if (imageUploadSection) {
                imageUploadSection.style.display = 'block';
            }
            document.getElementById('eventModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        });

        // ä½“é¨“ä¼šç·¨é›†
        function editEvent(eventId) {
            fetch(SCRIPT_URL + '?action=getEvent&eventId=' + eventId)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' && data.event) {
                        const event = data.event;
                        currentEditingEventId = eventId;
                        document.getElementById('modalTitle').textContent = 'ä½“é¨“ä¼šç·¨é›†';
                        // ç·¨é›†æ™‚ã¯ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ã€Œæ›´æ–°ã™ã‚‹ã€ã«å¤‰æ›´
                        const submitBtn = document.getElementById('submitBtn');
                        if (submitBtn) {
                            submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i>æ›´æ–°ã™ã‚‹';
                        }
                        
                        // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆã›ãšã€ç›´æ¥å€¤ã‚’è¨­å®š
                        document.getElementById('eventTitle').value = event.title || '';
                        document.getElementById('eventCategory').value = event.category || '';
                        document.getElementById('eventDescription').value = event.description || '';
                        
                        // æ—¥ä»˜ã¨æ™‚é–“ã®å‡¦ç†
                        let formattedDate = event.date || '';
                        if (formattedDate && formattedDate.includes('/')) {
                            formattedDate = formattedDate.replace(/\//g, '-');
                        }
                        
                        // æ™‚é–“ã®å‡¦ç†
                        let startDateTime = '';
                        let endDateTime = '';
                        if (event.time && formattedDate) {
                            const [startTime, endTime] = event.time.split('-');
                            if (startTime && endTime) {
                                startDateTime = formattedDate + ' ' + startTime.trim();
                                endDateTime = formattedDate + ' ' + endTime.trim();
                            }
                        }
                        
                        // é–‹å§‹æ—¥æ™‚ã¨çµ‚äº†æ—¥æ™‚ã‚’è¨­å®š
                        if (startDateTimePicker && startDateTime) {
                            startDateTimePicker.setDate(startDateTime, false);
                        }
                        if (endDateTimePicker && endDateTime) {
                            endDateTimePicker.setDate(endDateTime, false);
                        }
                        
                        // éè¡¨ç¤ºãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã‚‚è¨­å®šï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
                        document.getElementById('eventDate').value = formattedDate;
                        if (event.time) {
                            const [startTime, endTime] = event.time.split('-');
                            document.getElementById('eventStartTime').value = startTime ? startTime.trim() : '';
                            document.getElementById('eventEndTime').value = endTime ? endTime.trim() : '';
                        }
                        
                        document.getElementById('eventCapacity').value = event.capacity || '';
                        document.getElementById('eventCurrentParticipants').value = event.currentParticipants || 0;
                        document.getElementById('eventVenue').value = event.venue || 'pocopoco æ±äº¬éƒ½åºœä¸­æ–°ç”º1ä¸ç›®71-7';
                        document.getElementById('eventFee').value = event.fee || 'ç„¡æ–™';
                        document.getElementById('eventItems').value = event.items || '';
                        document.getElementById('eventRegistrant').value = event.registrant || '';
                        
                        // ç”»åƒã®è¡¨ç¤ºï¼ˆBase64ãƒ‡ãƒ¼ã‚¿ã‚’å„ªå…ˆï¼‰
                        if (event.imageBase64) {
                            document.getElementById('previewImg').src = 'data:image/jpeg;base64,' + event.imageBase64;
                            document.getElementById('imagePreview').classList.remove('hidden');
                        } else if (event.imageUrl) {
                            document.getElementById('previewImg').src = event.imageUrl;
                            document.getElementById('imagePreview').classList.remove('hidden');
                        } else {
                            document.getElementById('imagePreview').classList.add('hidden');
                        }
                        
                        // ç”»åƒå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç¢ºå®Ÿã«è¡¨ç¤º
                        const imageInput = document.getElementById('eventImage');
                        if (imageInput) {
                            imageInput.style.display = 'block';
                            imageInput.style.visibility = 'visible';
                        }
                        const imageUploadSection = document.getElementById('imageUploadSection');
                        if (imageUploadSection) {
                            imageUploadSection.style.display = 'block';
                        }
                        
                        document.getElementById('eventModal').classList.remove('hidden');
                        document.body.style.overflow = 'hidden';
                    } else {
                        alert('ã‚¤ãƒ™ãƒ³ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('ã‚¤ãƒ™ãƒ³ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                });
        }

        // ä½“é¨“ä¼šã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
        function archiveEvent(eventId) {
            if (!confirm('ã“ã®ä½“é¨“ä¼šã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'archiveEvent',
                    eventId: eventId
                })
            })
            .then(() => {
                alert('ä½“é¨“ä¼šã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã—ã¾ã—ãŸã€‚');
                loadEvents();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            });
        }

        // ä½“é¨“ä¼šã‚’å‰Šé™¤
        function deleteEvent(eventId) {
            if (!confirm('ã“ã®ä½“é¨“ä¼šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) return;
            
            fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'deleteEvent',
                    eventId: eventId
                })
            })
            .then(() => {
                alert('ä½“é¨“ä¼šã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
                loadEvents();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            });
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeModal() {
            document.getElementById('eventModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
            currentEditingEventId = null;
            document.getElementById('eventForm').reset();
            document.getElementById('imagePreview').classList.add('hidden');
            // ç”»åƒå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç¢ºå®Ÿã«è¡¨ç¤º
            const imageInput = document.getElementById('eventImage');
            if (imageInput) {
                imageInput.style.display = 'block';
                imageInput.value = ''; // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
            }
            const imageUploadSection = document.getElementById('imageUploadSection');
            if (imageUploadSection) {
                imageUploadSection.style.display = 'block';
            }
        }

        document.getElementById('closeModal')?.addEventListener('click', closeModal);
        document.getElementById('cancelBtn')?.addEventListener('click', closeModal);

        // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†ã¯ãƒˆãƒªãƒŸãƒ³ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆä¸‹è¨˜ï¼‰ã§å‡¦ç†

        // ä½“é¨“ä¼šã‚’ä¿å­˜
        function saveEvent(eventData, submitBtn, originalBtnText) {
            console.log('=== ä½“é¨“ä¼šä¿å­˜é–‹å§‹ ===');
            console.log('ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿:', JSON.stringify(eventData, null, 2));
            console.log('SCRIPT_URL:', SCRIPT_URL);
            
            // ç”»åƒãƒ‡ãƒ¼ã‚¿ã®ç¢ºèª
            console.log('ğŸ–¼ï¸ ç”»åƒãƒ‡ãƒ¼ã‚¿ã®ç¢ºèª:');
            console.log('  - imageBase64:', eventData.imageBase64 ? eventData.imageBase64.substring(0, 50) + '... (é•·ã•: ' + eventData.imageBase64.length + ')' : '(ç©º)');
            console.log('  - imageFileName:', eventData.imageFileName || '(ç©º)');
            
            // ãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼
            if (!eventData.title || !eventData.category || !eventData.date || !eventData.time) {
                alert('å¿…é ˆé …ç›®ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\n\nã‚¿ã‚¤ãƒˆãƒ«ã€ã‚«ãƒ†ã‚´ãƒªã€é–‹å‚¬æ—¥ã€é–‹å‚¬æ™‚é–“ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
                return;
            }
            
            // ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’1ã¤ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ä¸€ç·’ã«é€ä¿¡ï¼ˆGeminiæ¨å¥¨æ–¹å¼ï¼‰
            // ç”»åƒãŒã‚ã‚‹å ´åˆã¯ã€imageBase64ã¨imageFileNameã‚’å«ã‚ã¦é€ä¿¡
            // GASå´ã§ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®9åˆ—ç›®ã«URLã‚’ä¿å­˜ã™ã‚‹
            
            // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’ç¢ºèª
            const requestBody = JSON.stringify(eventData);
            const requestBodySizeMB = (requestBody.length / 1024 / 1024).toFixed(2);
            console.log('ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£:', requestBody.substring(0, 500) + '...'); // æœ€åˆã®500æ–‡å­—ã®ã¿è¡¨ç¤º
            console.log('ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã®é•·ã•:', requestBody.length, 'bytes (' + requestBodySizeMB + ' MB)');
            console.log('ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’å«ã‚ã¦é€ä¿¡:', {
                hasImage: !!eventData.imageBase64,
                imageSize: eventData.imageBase64 ? (eventData.imageBase64.length / 1024 / 1024).toFixed(2) + ' MB' : 'ãªã—',
                imageFileName: eventData.imageFileName || 'ãªã—',
                imageBase64Key: eventData.imageBase64 ? 'imageBase64 (å­˜åœ¨)' : 'imageBase64 (ãªã—)'
            });
            
            // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¿ãƒ–ã§ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¨˜éŒ²
            console.group('ğŸ“¤ ã‚¤ãƒ™ãƒ³ãƒˆä¿å­˜ãƒªã‚¯ã‚¨ã‚¹ãƒˆ');
            console.log('URL:', SCRIPT_URL);
            console.log('Method: POST');
            console.log('Headers:', { 'Content-Type': 'application/json' });
            console.log('Body:', {
                ...eventData,
                imageBase64: eventData.imageBase64 ? eventData.imageBase64.substring(0, 50) + '... (é•·ã•: ' + eventData.imageBase64.length + ')' : '(ç©º)'
            });
            console.groupEnd();
            
            // ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡å‰ã«æœ€çµ‚ç¢ºèª
            console.log('ğŸš€ ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡é–‹å§‹ï¼ˆç”»åƒå«ã‚€ï¼‰');
            console.log('é€ä¿¡URL:', SCRIPT_URL);
            console.log('é€ä¿¡ãƒ‡ãƒ¼ã‚¿ï¼ˆç”»åƒBase64ã¯çœç•¥ï¼‰:', {
                ...eventData,
                imageBase64: eventData.imageBase64 ? '(Base64ãƒ‡ãƒ¼ã‚¿: ' + eventData.imageBase64.length + 'æ–‡å­—)' : '(ç©º)'
            });
            
            // é€šå¸¸ã®CORSãƒ¢ãƒ¼ãƒ‰ã§è©¦è¡Œï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç¢ºèªã§ãã‚‹ï¼‰
            // é‡è¦: no-corsãƒ¢ãƒ¼ãƒ‰ã§ã¯GASå´ã§eãŒundefinedã«ãªã‚Šã€ãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡ã§ãã¾ã›ã‚“
            // é€šå¸¸ã®CORSãƒ¢ãƒ¼ãƒ‰ï¼ˆmodeã‚’æŒ‡å®šã—ãªã„ã€ã¾ãŸã¯'cors'ï¼‰ã§é€ä¿¡ã—ã¦ãã ã•ã„
            fetch(SCRIPT_URL, {
                method: 'POST',
                // modeã‚’æŒ‡å®šã—ãªã„ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯'cors'ï¼‰
                // no-corsãƒ¢ãƒ¼ãƒ‰ã§ã¯GASå´ã§eãŒundefinedã«ãªã‚‹ãŸã‚ã€ä½¿ç”¨ã—ãªã„
                headers: { 
                    'Content-Type': 'application/json'
                },
                body: requestBody
            })
            .then(response => {
                console.log('ğŸ“¥ ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡:', response.status, response.statusText);
                return response.text().then(text => {
                    console.log('ğŸ“¥ ãƒ¬ã‚¹ãƒãƒ³ã‚¹æœ¬æ–‡:', text);
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        console.warn('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®JSONãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—:', text);
                        return { status: 'unknown', raw: text };
                    }
                });
            })
            .then(data => {
                console.log('ğŸ“¥ ãƒ‘ãƒ¼ã‚¹æ¸ˆã¿ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', data);
                if (data.status === 'success') {
                    console.log('âœ… ã‚¤ãƒ™ãƒ³ãƒˆä¿å­˜æˆåŠŸï¼');
                    console.log('âœ… ã‚¤ãƒ™ãƒ³ãƒˆID:', data.eventId || '(ãªã—)');
                    console.log('âœ… ç”»åƒURL:', data.imageUrl || '(ãªã—)');
                    
                    // ç”»åƒã¯æ—¢ã«GASå´ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ï¼ˆ1ã¤ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§å‡¦ç†ï¼‰
                    if (eventData.imageBase64 && !data.imageUrl) {
                        console.warn('âš ï¸ ç”»åƒã‚’é€ä¿¡ã—ã¾ã—ãŸãŒã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«imageUrlãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                        console.warn('âš ï¸ GASã®å®Ÿè¡Œãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ã€ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒæˆåŠŸã—ãŸã‹ç¢ºèªã—ã¦ãã ã•ã„');
                    }
                    
                    alert('ä½“é¨“ä¼šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚' + (eventData.imageBase64 ? '\n\nç”»åƒã‚‚ä¸€ç·’ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚' : ''));
                    closeModal();
                    loadEvents();
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                } else {
                    console.error('âŒ ä¿å­˜å¤±æ•—:', data.message || data);
                    alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nã‚¨ãƒ©ãƒ¼: ' + (data.message || JSON.stringify(data)) + '\n\nãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã¨Google Apps Scriptã®å®Ÿè¡Œãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                }
            })
            .catch(error => {
                console.error('âŒ ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', error);
                // CORSã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯no-corsãƒ¢ãƒ¼ãƒ‰ã§å†è©¦è¡Œ
                if (error.name === 'TypeError' || error.message.includes('CORS') || error.message.includes('Failed to fetch')) {
                    console.log('âš ï¸ CORSã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸãŸã‚ã€no-corsãƒ¢ãƒ¼ãƒ‰ã§å†è©¦è¡Œã—ã¾ã™');
                    console.log('ğŸ“¤ no-corsãƒ¢ãƒ¼ãƒ‰ã§é€ä¿¡ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ï¼ˆç”»åƒBase64ã¯çœç•¥ï¼‰:', {
                        ...eventData,
                        imageBase64: eventData.imageBase64 ? '(Base64ãƒ‡ãƒ¼ã‚¿: ' + eventData.imageBase64.length + 'æ–‡å­—)' : '(ç©º)'
                    });
                    console.log('ğŸ“¤ ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã®é•·ã•:', requestBody.length, 'bytes (' + (requestBody.length / 1024 / 1024).toFixed(2) + ' MB)');
                    console.log('ğŸ“¤ ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’å«ã‚ã¦é€ä¿¡:', {
                        hasImage: !!eventData.imageBase64,
                        imageSize: eventData.imageBase64 ? (eventData.imageBase64.length / 1024 / 1024).toFixed(2) + ' MB' : 'ãªã—'
                    });
                    
                    // no-corsãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€Content-Typeãƒ˜ãƒƒãƒ€ãƒ¼ãŒç„¡è¦–ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€
                    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’ãã®ã¾ã¾é€ä¿¡
                    // æ³¨æ„: no-corsãƒ¢ãƒ¼ãƒ‰ã§ã¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å–å¾—ã§ãã¾ã›ã‚“ãŒã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯é€ä¿¡ã•ã‚Œã¾ã™
                    // ç”»åƒã‚‚å«ã‚ã¦1ã¤ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§é€ä¿¡ï¼ˆGASå´ã§ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜ï¼‰
                    fetch(SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        cache: 'no-cache',
                        credentials: 'omit',
                        headers: { 
                            'Content-Type': 'application/json'
                        },
                        body: requestBody
                    })
                    .then(() => {
                        console.log('âœ… no-corsãƒ¢ãƒ¼ãƒ‰ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡å®Œäº†');
                        console.log('âš ï¸ Google Apps Scriptã®å®Ÿè¡Œãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
                        console.log('âš ï¸ ç‰¹ã«ä»¥ä¸‹ã‚’ç¢ºèªï¼š');
                        console.log('   1. ã€Œe ã®å­˜åœ¨ã€ãŒ true ã«ãªã£ã¦ã„ã‚‹ã‹');
                        console.log('   2. ã€Œe.postData.contentsã€ã«ãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹');
                        console.log('   3. ã€Œparams.imageBase64 ã®å­˜åœ¨ã€ãŒ true ã«ãªã£ã¦ã„ã‚‹ã‹');
                        console.log('   4. ã€Œâœ… ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸã€ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹');
                        console.log('   5. ã€ŒğŸ“ 9åˆ—ç›®ï¼ˆç”»åƒURLï¼‰ã€ã«URLãŒå…¥ã£ã¦ã„ã‚‹ã‹');
                        
                        setTimeout(() => {
                            console.log('ğŸ”„ ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿');
                            loadEvents();
                            alert('ä½“é¨“ä¼šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚' + (eventData.imageBase64 ? '\n\nç”»åƒã‚‚ä¸€ç·’ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚' : '') + '\n\nâš ï¸ å®Ÿéš›ã«ä¿å­˜ã•ã‚ŒãŸã‹ç¢ºèªã—ã¦ãã ã•ã„ï¼š\n1. Google Apps Scriptã®å®Ÿè¡Œãƒ­ã‚°ã§ã€ŒğŸ“ 9åˆ—ç›®ï¼ˆç”»åƒURLï¼‰ã€ã‚’ç¢ºèª\n2. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ã€Œã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ã€ã‚¿ãƒ–ã®9åˆ—ç›®\n3. Google Driveã®æŒ‡å®šãƒ•ã‚©ãƒ«ãƒ€\n\nã‚‚ã—ä¿å­˜ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€GASã®ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                            closeModal();
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = originalBtnText;
                        }, 3000);
                    })
                    .catch(noCorsError => {
                        console.error('âŒ no-corsãƒ¢ãƒ¼ãƒ‰ã§ã‚‚ã‚¨ãƒ©ãƒ¼:', noCorsError);
                        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã¨Google Apps Scriptã®å®Ÿè¡Œãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n\nç‰¹ã«ä»¥ä¸‹ã‚’ç¢ºèªï¼š\n1. GASã®å®Ÿè¡Œãƒ­ã‚°ã§ã€Œe ã®å­˜åœ¨ã€ãŒ true ã«ãªã£ã¦ã„ã‚‹ã‹\n2. ã€Œe.postData.contentsã€ã«ãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹\n3. ã€Œparams.imageBase64 ã®å­˜åœ¨ã€ãŒ true ã«ãªã£ã¦ã„ã‚‹ã‹\n\nã‚¨ãƒ©ãƒ¼: ' + noCorsError.message);
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalBtnText;
                    });
                } else {
                    alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nã‚¨ãƒ©ãƒ¼: ' + error.message + '\n\nãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã¨Google Apps Scriptã®å®Ÿè¡Œãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                }
            });
        }
    </script>

    <!-- ç”»åƒãƒˆãƒªãƒŸãƒ³ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="cropModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4" style="z-index: 9999;">
        <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-auto" style="position: relative;">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-brand-main">ç”»åƒã‚’ãƒˆãƒªãƒŸãƒ³ã‚°</h3>
                    <button id="closeCropModal" class="text-gray-500 hover:text-gray-700" style="cursor: pointer;">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                <div class="mb-4 bg-gray-100 p-4 rounded-lg">
                    <img id="cropImage" src="" alt="ãƒˆãƒªãƒŸãƒ³ã‚°å¯¾è±¡" style="max-width: 100%; display: block;">
                </div>
                <div class="flex gap-3 justify-end mt-4" style="position: sticky; bottom: 0; background: white; padding: 1rem 0; margin: 0 -1.5rem -1.5rem; padding-left: 1.5rem; padding-right: 1.5rem; border-top: 1px solid #e5e7eb; width: calc(100% + 3rem);">
                    <button id="cancelCrop" type="button" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-bold" style="cursor: pointer; min-width: 120px;">
                        <i class="fas fa-times mr-2"></i>ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                    <button id="applyCrop" type="button" class="px-6 py-3 bg-brand-cta text-white rounded-lg hover:bg-orange-600 transition font-bold shadow-md" style="cursor: pointer; min-width: 120px;">
                        <i class="fas fa-check mr-2"></i>ç¢ºå®š
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cropper.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§æ—¥æ™‚ãƒ”ãƒƒã‚«ãƒ¼ã‚’ä¿æŒ
        let startDateTimePicker = null;
        let endDateTimePicker = null;
        let deadlinePicker = null;
        
        // DOMContentLoadedã‚¤ãƒ™ãƒ³ãƒˆã§å®Ÿè¡Œï¼ˆDOMãŒèª­ã¿è¾¼ã¾ã‚ŒãŸå¾Œã«å®Ÿè¡Œï¼‰
        document.addEventListener('DOMContentLoaded', function() {
            
            // Flatpickrã§é–‹å§‹æ—¥æ™‚ã‚’åˆæœŸåŒ–ï¼ˆæ—¥ä»˜ã¨æ™‚é–“ã‚’ä¸€ç·’ã«é¸æŠï¼‰
            const eventStartDateTimeInput = document.getElementById('eventStartDateTime');
            if (eventStartDateTimeInput) {
                startDateTimePicker = flatpickr(eventStartDateTimeInput, {
                    enableTime: true,
                    dateFormat: "Y-m-d H:i",
                    time_24hr: true,
                    locale: flatpickr.l10ns.ja,
                    allowInput: false,
                    clickOpens: true,
                    minuteIncrement: 15, // 15åˆ†åˆ»ã¿
                    onChange: function(selectedDates, dateStr, instance) {
                        // é–‹å§‹æ—¥æ™‚ãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰ã€çµ‚äº†æ—¥æ™‚ã®æœ€å°å€¤ã‚’æ›´æ–°
                        if (endDateTimePicker && selectedDates.length > 0) {
                            endDateTimePicker.set('minDate', selectedDates[0]);
                        }
                        // é–‹å§‹æ—¥æ™‚ã‹ã‚‰æ—¥ä»˜ã‚’æŠ½å‡ºã—ã¦ã€eventDateã¨eventStartTimeã«è¨­å®š
                        if (selectedDates.length > 0) {
                            const date = selectedDates[0];
                            const dateStr = date.getFullYear() + '-' + 
                                          String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                                          String(date.getDate()).padStart(2, '0');
                            const timeStr = String(date.getHours()).padStart(2, '0') + ':' + 
                                          String(date.getMinutes()).padStart(2, '0');
                            document.getElementById('eventDate').value = dateStr;
                            document.getElementById('eventStartTime').value = timeStr;
                        }
                    }
                });
                console.log('âœ… Flatpickré–‹å§‹æ—¥æ™‚ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ');
            }
            
            // Flatpickrã§çµ‚äº†æ—¥æ™‚ã‚’åˆæœŸåŒ–ï¼ˆæ—¥ä»˜ã¨æ™‚é–“ã‚’ä¸€ç·’ã«é¸æŠï¼‰
            const eventEndDateTimeInput = document.getElementById('eventEndDateTime');
            if (eventEndDateTimeInput) {
                endDateTimePicker = flatpickr(eventEndDateTimeInput, {
                    enableTime: true,
                    dateFormat: "Y-m-d H:i",
                    time_24hr: true,
                    locale: flatpickr.l10ns.ja,
                    allowInput: false,
                    clickOpens: true,
                    minuteIncrement: 15, // 15åˆ†åˆ»ã¿
                    onChange: function(selectedDates, dateStr, instance) {
                        // çµ‚äº†æ—¥æ™‚ã‹ã‚‰æ—¥ä»˜ã‚’æŠ½å‡ºã—ã¦ã€eventEndTimeã«è¨­å®š
                        if (selectedDates.length > 0) {
                            const date = selectedDates[0];
                            const timeStr = String(date.getHours()).padStart(2, '0') + ':' + 
                                          String(date.getMinutes()).padStart(2, '0');
                            document.getElementById('eventEndTime').value = timeStr;
                        }
                    }
                });
                console.log('âœ… Flatpickrçµ‚äº†æ—¥æ™‚ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ');
            }
            
            console.log('âœ… DOMContentLoaded: ãƒˆãƒªãƒŸãƒ³ã‚°æ©Ÿèƒ½ã®åˆæœŸåŒ–é–‹å§‹');
            
            let cropper = null;
            let originalImageFile = null;

            // ç”»åƒé¸æŠæ™‚ã®å‡¦ç†ã‚’å¤‰æ›´
            const eventImageInput = document.getElementById('eventImage');
            if (!eventImageInput) {
                console.error('âŒ eventImageè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            console.log('âœ… eventImageè¦ç´ ã‚’å–å¾—ã—ã¾ã—ãŸ');

            eventImageInput.addEventListener('change', function(e) {
                console.log('ğŸ–¼ï¸ ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¾ã—ãŸ');
                const file = e.target.files[0];
                if (file) {
                    console.log('ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±:', file.name, file.size, 'bytes', file.type);
                    originalImageFile = file;
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        console.log('âœ… ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†');
                        // ãƒˆãƒªãƒŸãƒ³ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                        const cropImage = document.getElementById('cropImage');
                        const cropModal = document.getElementById('cropModal');
                        
                        if (!cropImage) {
                            console.error('âŒ cropImageè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                            return;
                        }
                        if (!cropModal) {
                            console.error('âŒ cropModalè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                            return;
                        }
                        
                        cropImage.src = e.target.result;
                        cropModal.classList.remove('hidden');
                        console.log('âœ… ãƒˆãƒªãƒŸãƒ³ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
                        
                        // Cropper.jsã‚’åˆæœŸåŒ–
                        if (cropper) {
                            cropper.destroy();
                        }
                        
                        // Cropper.jsãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
                        if (typeof Cropper === 'undefined') {
                            console.error('âŒ Cropper.jsãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                            alert('ç”»åƒãƒˆãƒªãƒŸãƒ³ã‚°æ©Ÿèƒ½ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
                            return;
                        }
                        
                        console.log('ğŸ”„ Cropper.jsã‚’åˆæœŸåŒ–ã—ã¾ã™');
                        cropper = new Cropper(cropImage, {
                        aspectRatio: 16 / 9, // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’16:9ã«è¨­å®šï¼ˆå¿…è¦ã«å¿œã˜ã¦å¤‰æ›´å¯èƒ½ï¼‰
                        viewMode: 1,
                        dragMode: 'move',
                        autoCropArea: 1.0, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ç”»åƒå…¨ä½“ã‚’é¸æŠ
                        restore: false,
                        guides: true,
                        center: true,
                        highlight: false,
                        cropBoxMovable: true,
                        cropBoxResizable: true,
                        toggleable: false,
                        minCropBoxWidth: 200,
                        minCropBoxHeight: 112,
                        responsive: true,
                        background: true,
                        modal: true,
                        ready: function() {
                            console.log('âœ… Cropper.jsåˆæœŸåŒ–å®Œäº†');
                            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ç”»åƒå…¨ä½“ã‚’é¸æŠï¼ˆã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ç¶­æŒã—ãªãŒã‚‰æœ€å¤§ã‚µã‚¤ã‚ºï¼‰
                            const imageData = cropper.getImageData();
                            const containerData = cropper.getContainerData();
                            const cropBoxData = cropper.getCropBoxData();
                            
                            // ç”»åƒå…¨ä½“ã‚’ã‚«ãƒãƒ¼ã™ã‚‹ã‚ˆã†ã«ãƒˆãƒªãƒŸãƒ³ã‚°æ ã‚’è¨­å®š
                            cropper.setCropBoxData({
                                left: 0,
                                top: 0,
                                width: Math.min(imageData.naturalWidth, containerData.width),
                                height: Math.min(imageData.naturalHeight, containerData.height)
                            });
                            console.log('ğŸ“ ãƒˆãƒªãƒŸãƒ³ã‚°ã‚¨ãƒªã‚¢ã‚’ãƒ•ãƒ«ã‚µã‚¤ã‚ºã«è¨­å®šã—ã¾ã—ãŸ');
                        }
                    });
                };
                reader.readAsDataURL(file);
            }
        });

            // ãƒˆãƒªãƒŸãƒ³ã‚°é©ç”¨
            const applyCropBtn = document.getElementById('applyCrop');
            if (!applyCropBtn) {
                console.error('âŒ applyCropãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            } else {
                console.log('âœ… applyCropãƒœã‚¿ãƒ³ã‚’å–å¾—ã—ã¾ã—ãŸ');
                applyCropBtn.addEventListener('click', function() {
                    console.log('ğŸ–±ï¸ ç¢ºå®šãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
                    if (cropper) {
                        const canvas = cropper.getCroppedCanvas({
                            width: 800,  // å‡ºåŠ›ã‚µã‚¤ã‚ºï¼ˆå¿…è¦ã«å¿œã˜ã¦èª¿æ•´ï¼‰
                            height: 450,
                            imageSmoothingEnabled: true,
                            imageSmoothingQuality: 'high'
                        });
                        
                        if (canvas) {
                            // Canvasã‚’Base64ã«å¤‰æ›
                            const base64Data = canvas.toDataURL('image/jpeg', 0.9).split(',')[1];
                            
                            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
                            document.getElementById('previewImg').src = canvas.toDataURL('image/jpeg', 0.9);
                            document.getElementById('imagePreview').classList.remove('hidden');
                            
                            // ãƒˆãƒªãƒŸãƒ³ã‚°å¾Œã®ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆå¾Œã§ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã«ä½¿ç”¨ï¼‰
                            document.getElementById('eventImage').dataset.croppedBase64 = base64Data;
                            
                            // å…ƒã®ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚‚ä¿å­˜ï¼ˆç¯„å›²ä¿®æ­£æ™‚ã«ä½¿ç”¨ï¼‰
                            if (originalImageFile) {
                                // å…ƒã®ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’Blobã¨ã—ã¦ä¿å­˜ï¼ˆç¯„å›²ä¿®æ­£æ™‚ã«å†èª­ã¿è¾¼ã¿ç”¨ï¼‰
                                const reader = new FileReader();
                                reader.onload = function(e) {
                                    document.getElementById('eventImage').dataset.originalImageData = e.target.result;
                                };
                                reader.readAsDataURL(originalImageFile);
                            }
                            
                            // å…ƒã®ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚‚ä¿å­˜ï¼ˆç¯„å›²ä¿®æ­£æ™‚ã«ä½¿ç”¨ï¼‰
                            if (originalImageFile) {
                                document.getElementById('eventImage').dataset.originalFile = JSON.stringify({
                                    name: originalImageFile.name,
                                    type: originalImageFile.type,
                                    size: originalImageFile.size
                                });
                            }
                            
                            console.log('âœ… ç”»åƒãƒˆãƒªãƒŸãƒ³ã‚°å®Œäº†');
                            console.log('ğŸ“ ãƒˆãƒªãƒŸãƒ³ã‚°å¾Œã®ã‚µã‚¤ã‚º:', canvas.width, 'x', canvas.height);
                            console.log('ğŸ“¦ Base64ãƒ‡ãƒ¼ã‚¿ã®é•·ã•:', base64Data.length);
                            
                            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                            document.getElementById('cropModal').classList.add('hidden');
                            if (cropper) {
                                cropper.destroy();
                                cropper = null;
                            }
                        } else {
                            console.error('âŒ Canvasã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                            alert('ç”»åƒã®ãƒˆãƒªãƒŸãƒ³ã‚°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                        }
                    } else {
                        console.error('âŒ CropperãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                        alert('ç”»åƒãƒˆãƒªãƒŸãƒ³ã‚°æ©Ÿèƒ½ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
                    }
                });
            }

            // ãƒˆãƒªãƒŸãƒ³ã‚°ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            const cancelCropBtn = document.getElementById('cancelCrop');
            if (cancelCropBtn) {
                cancelCropBtn.addEventListener('click', function() {
                    console.log('ğŸ–±ï¸ ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
                    document.getElementById('cropModal').classList.add('hidden');
                    if (cropper) {
                        cropper.destroy();
                        cropper = null;
                    }
                    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
                    document.getElementById('eventImage').value = '';
                    document.getElementById('imagePreview').classList.add('hidden');
                    originalImageFile = null;
                });
            }

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            const closeCropModalBtn = document.getElementById('closeCropModal');
            if (closeCropModalBtn) {
                closeCropModalBtn.addEventListener('click', function() {
                    console.log('ğŸ–±ï¸ é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
                    document.getElementById('cropModal').classList.add('hidden');
                    if (cropper) {
                        cropper.destroy();
                        cropper = null;
                    }
                    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
                    document.getElementById('eventImage').value = '';
                    document.getElementById('imagePreview').classList.add('hidden');
                    originalImageFile = null;
                });
            }

            // ç¯„å›²ã‚’ä¿®æ­£ã™ã‚‹ãƒœã‚¿ãƒ³
            const reCropBtn = document.getElementById('reCropBtn');
            if (reCropBtn) {
                console.log('âœ… reCropBtnãƒœã‚¿ãƒ³ã‚’å–å¾—ã—ã¾ã—ãŸ');
                reCropBtn.addEventListener('click', function() {
                    console.log('ğŸ–±ï¸ ç¯„å›²ã‚’ä¿®æ­£ã™ã‚‹ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
                    
                    // ä¿å­˜ã•ã‚Œã¦ã„ã‚‹å…ƒã®ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                    const originalImageData = document.getElementById('eventImage').dataset.originalImageData;
                    const imageFile = document.getElementById('eventImage').files[0];
                    
                    let imageSource = null;
                    
                    if (originalImageData) {
                        // ä¿å­˜ã•ã‚Œã¦ã„ã‚‹å…ƒã®ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
                        imageSource = originalImageData;
                        console.log('ğŸ“ ä¿å­˜ã•ã‚Œã¦ã„ã‚‹å…ƒã®ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨');
                    } else if (imageFile) {
                        // å…ƒã®ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†èª­ã¿è¾¼ã¿
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            openCropModal(e.target.result);
                        };
                        reader.readAsDataURL(imageFile);
                        return;
                    } else {
                        alert('å…ƒã®ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ç”»åƒã‚’å†åº¦é¸æŠã—ã¦ãã ã•ã„ã€‚');
                        return;
                    }
                    
                    if (imageSource) {
                        openCropModal(imageSource);
                    }
                });
            } else {
                console.warn('âš ï¸ reCropBtnãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
            
            // ãƒˆãƒªãƒŸãƒ³ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãé–¢æ•°
            function openCropModal(imageDataUrl) {
                const cropImage = document.getElementById('cropImage');
                const cropModal = document.getElementById('cropModal');
                
                cropImage.src = imageDataUrl;
                cropModal.classList.remove('hidden');
                console.log('âœ… ãƒˆãƒªãƒŸãƒ³ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã—ã¾ã—ãŸï¼ˆç¯„å›²ä¿®æ­£ï¼‰');
                
                // Cropper.jsã‚’å†åˆæœŸåŒ–
                if (cropper) {
                    cropper.destroy();
                }
                
                cropper = new Cropper(cropImage, {
                    aspectRatio: 16 / 9,
                    viewMode: 1,
                    dragMode: 'move',
                    autoCropArea: 1.0, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ç”»åƒå…¨ä½“ã‚’é¸æŠ
                    restore: false,
                    guides: true,
                    center: true,
                    highlight: false,
                    cropBoxMovable: true,
                    cropBoxResizable: true,
                    toggleable: false,
                    minCropBoxWidth: 200,
                    minCropBoxHeight: 112,
                    responsive: true,
                    background: true,
                    modal: true,
                    ready: function() {
                        console.log('âœ… Cropper.jså†åˆæœŸåŒ–å®Œäº†ï¼ˆç¯„å›²ä¿®æ­£ï¼‰');
                        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ç”»åƒå…¨ä½“ã‚’é¸æŠ
                        const imageData = cropper.getImageData();
                        const containerData = cropper.getContainerData();
                        cropper.setCropBoxData({
                            left: 0,
                            top: 0,
                            width: Math.min(imageData.naturalWidth, containerData.width),
                            height: Math.min(imageData.naturalHeight, containerData.height)
                        });
                    }
                });
            }

        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®å‡¦ç†ã‚’ä¿®æ­£ï¼ˆãƒˆãƒªãƒŸãƒ³ã‚°å¾Œã®ç”»åƒã‚’ä½¿ç”¨ï¼‰
        const originalFormSubmit = document.getElementById('eventForm')?.addEventListener('submit', function(e) {
            e.preventDefault();

            const imageFile = document.getElementById('eventImage').files[0];
            const croppedBase64 = document.getElementById('eventImage').dataset.croppedBase64;
            
            // é–‹å§‹æ—¥æ™‚ã¨çµ‚äº†æ—¥æ™‚ã‹ã‚‰æ—¥ä»˜ã¨æ™‚é–“ã‚’æŠ½å‡º
            const startDateTimeStr = document.getElementById('eventStartDateTime').value;
            const endDateTimeStr = document.getElementById('eventEndDateTime').value;
            
            let eventDate = '';
            let startTime = '';
            let endTime = '';
            
            if (startDateTimeStr) {
                const startParts = startDateTimeStr.split(' ');
                if (startParts.length === 2) {
                    eventDate = startParts[0];
                    startTime = startParts[1];
                }
            }
            
            if (endDateTimeStr) {
                const endParts = endDateTimeStr.split(' ');
                if (endParts.length === 2) {
                    endTime = endParts[1];
                }
            }
            
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: éè¡¨ç¤ºãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰å–å¾—
            if (!eventDate) eventDate = document.getElementById('eventDate').value;
            if (!startTime) startTime = document.getElementById('eventStartTime').value;
            if (!endTime) endTime = document.getElementById('eventEndTime').value;
            
            const eventData = {
                action: currentEditingEventId ? 'updateEvent' : 'createEvent',
                eventId: currentEditingEventId,
                title: document.getElementById('eventTitle').value,
                category: document.getElementById('eventCategory').value,
                description: document.getElementById('eventDescription').value,
                date: eventDate,
                startTime: startTime,
                endTime: endTime,
                time: startTime + '-' + endTime,
                capacity: parseInt(document.getElementById('eventCapacity').value),
                currentParticipants: parseInt(document.getElementById('eventCurrentParticipants').value) || 0,
                venue: document.getElementById('eventVenue').value,
                fee: document.getElementById('eventFee').value,
                items: document.getElementById('eventItems').value,
                registrant: document.getElementById('eventRegistrant').value
            };
            
            // ãƒ‡ãƒãƒƒã‚°ï¼šé€ä¿¡å‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª
            console.log('=== ğŸ“ ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‰ã®ãƒ‡ãƒ¼ã‚¿ç¢ºèª ===');
            console.log('eventData:', eventData);
            console.log('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«:', imageFile ? imageFile.name + ' (' + imageFile.size + ' bytes)' : 'ãªã—');
            console.log('ãƒˆãƒªãƒŸãƒ³ã‚°å¾Œã®Base64ãƒ‡ãƒ¼ã‚¿:', croppedBase64 ? croppedBase64.substring(0, 50) + '... (é•·ã•: ' + croppedBase64.length + ')' : 'ãªã—');

            const submitBtn = document.getElementById('submitBtn');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> ä¿å­˜ä¸­...';

            // ãƒˆãƒªãƒŸãƒ³ã‚°å¾Œã®ç”»åƒãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°å…ƒã®ç”»åƒã‚’ä½¿ç”¨
            if (croppedBase64) {
                console.log('ğŸ–¼ï¸ ãƒˆãƒªãƒŸãƒ³ã‚°å¾Œã®ç”»åƒã‚’ä½¿ç”¨');
                eventData.imageBase64 = croppedBase64;
                eventData.imageFileName = imageFile ? imageFile.name : 'cropped_image.jpg';
                saveEvent(eventData, submitBtn, originalBtnText);
            } else if (imageFile) {
                console.log('ğŸ–¼ï¸ å…ƒã®ç”»åƒã‚’ä½¿ç”¨ï¼ˆãƒˆãƒªãƒŸãƒ³ã‚°ãªã—ï¼‰');
                const reader = new FileReader();
                reader.onload = function(e) {
                    console.log('ğŸ–¼ï¸ ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†');
                    const base64Data = e.target.result.split(',')[1];
                    console.log('ğŸ–¼ï¸ Base64ãƒ‡ãƒ¼ã‚¿ã®é•·ã•:', base64Data ? base64Data.length : 0);
                    eventData.imageBase64 = base64Data;
                    eventData.imageFileName = imageFile.name;
                    saveEvent(eventData, submitBtn, originalBtnText);
                };
                reader.onerror = function(error) {
                    console.error('âŒ ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    alert('ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                };
                reader.readAsDataURL(imageFile);
            } else {
                console.log('â„¹ï¸ ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãªã—');
                saveEvent(eventData, submitBtn, originalBtnText);
            }
            });
        }); // DOMContentLoadedçµ‚äº†
    </script>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <footer class="bg-gray-800 text-gray-400 py-8 text-center text-xs mt-12">
        <p>&copy; 2025 pocopoco All Rights Reserved.</p>
    </footer>
</body>
</html>

