<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>相談・見学予約 | 児童発達支援 pocopoco</title>
    <link rel="icon" type="image/png" href="images/favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Zen+Maru+Gothic:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="js/config.js"></script>
    <link rel="stylesheet" href="css/style.css">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #FDFCF0; color: #4A4A4A; }
        h1, h2 { font-family: 'Zen Maru Gothic', sans-serif; }
    </style>
</head>
<body class="antialiased">

    <!-- ヘッダー -->
    <header class="bg-white/90 backdrop-blur-sm fixed top-0 w-full z-40 shadow-sm border-b border-stone-200">
        <div class="max-w-md mx-auto px-4 py-3 flex justify-between items-center">
            <a href="index.html" class="font-bold text-brand-main text-xl tracking-wider font-maru hover:opacity-80 transition">
                <img src="images/logo.png" alt="pocopoco" class="h-9">
            </a>
            <a href="index.html" class="text-sm text-gray-500 hover:text-brand-main transition">
                <i class="fas fa-arrow-left mr-1"></i>TOPへ戻る
            </a>
        </div>
    </header>

    <main class="pt-20 pb-12 px-4 max-w-md mx-auto">
        <div class="text-center mb-8">
            <h1 class="text-2xl font-bold text-brand-main mb-2">相談・見学予約</h1>
            <p class="text-sm text-gray-600">
                以下のフォームよりお気軽にお問い合わせください。<br>
                2営業日以内に担当者よりご連絡いたします。
            </p>
        </div>

        <!-- フォームエリア -->
        <div id="formContainer">
            <form id="reservationForm" class="bg-white p-6 rounded-xl shadow-md space-y-6">
                
                <!-- 保護者氏名 -->
                <div>
                    <label for="parentName" class="block text-sm font-bold text-gray-700 mb-1">保護者様のお名前 <span class="text-red-500 text-xs">*必須</span></label>
                    <input type="text" id="parentName" name="parentName" required placeholder="例：山田 花子" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-cta focus:border-brand-cta block p-3">
                </div>

                <!-- お子様氏名 -->
                <div>
                    <label for="childName" class="block text-sm font-bold text-gray-700 mb-1">お子さまのお名前 <span class="text-gray-400 text-xs">(任意)</span></label>
                    <input type="text" id="childName" name="childName" placeholder="例：山田 太郎" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-cta focus:border-brand-cta block p-3">
                </div>

                <!-- 年齢 -->
                <div>
                    <label for="childAge" class="block text-sm font-bold text-gray-700 mb-1">お子さまの年齢 <span class="text-gray-400 text-xs">(任意)</span></label>
                    <select id="childAge" name="childAge" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-cta focus:border-brand-cta block p-3">
                        <option value="">選択してください</option>
                        <option value="0歳">0歳</option>
                        <option value="1歳">1歳</option>
                        <option value="2歳">2歳</option>
                        <option value="3歳 (年少)">3歳 (年少)</option>
                        <option value="4歳 (年中)">4歳 (年中)</option>
                        <option value="5歳 (年長)">5歳 (年長)</option>
                        <option value="6歳 (就学前)">6歳 (就学前)</option>
                    </select>
                </div>

                <!-- メールアドレス -->
                <div>
                    <label for="email" class="block text-sm font-bold text-gray-700 mb-1">メールアドレス <span class="text-red-500 text-xs">*必須</span></label>
                    <input type="email" id="email" name="email" required placeholder="example@email.com" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-cta focus:border-brand-cta block p-3">
                </div>

                <!-- 電話番号 -->
                <div>
                    <label for="tel" class="block text-sm font-bold text-gray-700 mb-1">電話番号 <span class="text-red-500 text-xs">*必須</span></label>
                    <input type="tel" id="tel" name="tel" required placeholder="090-0000-0000" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-cta focus:border-brand-cta block p-3">
                </div>

                <!-- 受給者証の有無 -->
                <div>
                    <label for="certificate" class="block text-sm font-bold text-gray-700 mb-1">受給者証の有無 <span class="text-red-500 text-xs">*必須</span></label>
                    <select id="certificate" name="certificate" required class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-cta focus:border-brand-cta block p-3">
                        <option value="">選択してください</option>
                        <option value="持っている">持っている</option>
                        <option value="申請手続き中">申請手続き中</option>
                        <option value="持っていない">持っていない</option>
                    </select>
                </div>

                <!-- ご希望内容 -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">お問い合わせ内容 <span class="text-red-500 text-xs">*必須</span></label>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="checkbox" name="type" value="見学希望" id="typeVisit" class="w-4 h-4 text-brand-cta bg-gray-100 border-gray-300 rounded focus:ring-brand-cta">
                            <span class="ml-2 text-sm text-gray-600">施設の見学をしたい</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="type" value="面談希望" id="typeConsultation" class="w-4 h-4 text-brand-cta bg-gray-100 border-gray-300 rounded focus:ring-brand-cta">
                            <span class="ml-2 text-sm text-gray-600">個別面談・相談をしたい</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="type" value="受給者証について" class="w-4 h-4 text-brand-cta bg-gray-100 border-gray-300 rounded focus:ring-brand-cta">
                            <span class="ml-2 text-sm text-gray-600">受給者証について聞きたい</span>
                        </label>
                    </div>
                </div>

                <!-- カレンダー選択エリア（見学・面談希望の場合のみ表示） -->
                <div id="calendarSection" class="hidden">
                    <label class="block text-sm font-bold text-gray-700 mb-3">ご希望の日時を選択 <span class="text-red-500 text-xs">*必須</span></label>
                    
                    <!-- カレンダー -->
                    <div class="bg-white border border-gray-200 rounded-lg p-4 mb-4">
                        <div class="flex justify-between items-center mb-4">
                            <button type="button" id="prevMonth" class="text-gray-600 hover:text-brand-main transition">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <h3 id="currentMonth" class="text-lg font-bold text-gray-800"></h3>
                            <button type="button" id="nextMonth" class="text-gray-600 hover:text-brand-main transition">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="grid grid-cols-7 gap-1 mb-2">
                            <div class="text-center text-xs text-gray-500 py-1">日</div>
                            <div class="text-center text-xs text-gray-500 py-1">月</div>
                            <div class="text-center text-xs text-gray-500 py-1">火</div>
                            <div class="text-center text-xs text-gray-500 py-1">水</div>
                            <div class="text-center text-xs text-gray-500 py-1">木</div>
                            <div class="text-center text-xs text-gray-500 py-1">金</div>
                            <div class="text-center text-xs text-gray-500 py-1">土</div>
                        </div>
                        <div id="calendarDays" class="grid grid-cols-7 gap-1"></div>
                    </div>

                    <!-- 時間帯選択 -->
                    <div id="timeSlotSection" class="hidden">
                        <label class="block text-sm font-bold text-gray-700 mb-2">時間帯を選択 <span class="text-red-500 text-xs">*必須</span></label>
                        <div id="selectedDate" class="text-sm text-gray-600 mb-3"></div>
                        <div id="timeSlots" class="grid grid-cols-2 gap-2"></div>
                    </div>

                    <!-- 選択した候補日時表示 -->
                    <div id="selectedDateTimesContainer" class="mt-4">
                        <div class="text-xs text-gray-500 mb-2">選択した候補日時（最大3つ）</div>
                        <div id="selectedDateTimesList" class="space-y-2"></div>
                        <div id="maxSelectionsMessage" class="hidden mt-2 text-xs text-red-500">
                            最大3つまで選択できます
                        </div>
                    </div>
                </div>

                <!-- その他ご質問など -->
                <div>
                    <label for="message" class="block text-sm font-bold text-gray-700 mb-1">その他ご質問など <span class="text-gray-400 text-xs">(任意)</span></label>
                    <textarea id="message" name="message" rows="4" placeholder="（例）兄弟の同席は可能でしょうか？" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-cta focus:border-brand-cta block p-3"></textarea>
                </div>

                <div class="pt-4">
                    <button type="submit" id="submitBtn" class="w-full text-white bg-brand-cta hover:bg-orange-600 focus:ring-4 focus:outline-none focus:ring-orange-300 font-bold rounded-full text-lg px-5 py-4 text-center shadow-lg transition transform hover:-translate-y-1">
                        送信する <i class="fas fa-paper-plane ml-2"></i>
                    </button>
                    <p class="text-center text-xs text-gray-400 mt-3">※個人情報は厳重に管理し、お問い合わせ対応以外には使用いたしません。</p>
                </div>
            </form>
        </div>

        <!-- 送信完了メッセージ (初期は非表示) -->
        <div id="successMessage" class="hidden bg-white p-8 rounded-xl shadow-md text-center">
            <div class="w-16 h-16 bg-green-100 text-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-check text-3xl"></i>
            </div>
            <h2 class="text-xl font-bold text-brand-main mb-2">送信完了しました</h2>
            <p class="text-sm text-gray-600 mb-6">
                お問い合わせありがとうございます。<br>
                内容を確認次第、担当者よりご連絡いたします。
            </p>
            <a href="index.html" class="block w-full bg-brand-main text-white font-bold py-3 rounded-full hover:bg-brown-700 transition">
                TOPへ戻る
            </a>
        </div>

        <div class="mt-8 text-center" id="contactOptions">

            <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">

                <p class="text-sm font-bold text-gray-600 mb-3">

                    <i class="fas fa-exclamation-circle text-brand-cta mr-1"></i>お急ぎの場合はお電話ください

                </p>

                <a href="tel:042-306-7126" class="inline-flex items-center text-brand-main hover:text-brand-cta transition pb-0.5 group">

                    <i class="fas fa-phone-alt mr-2 text-xl group-hover:rotate-12 transition-transform"></i>

                    <span class="text-2xl font-bold tracking-wider font-sans">042-306-7126</span>

                </a>

                <p class="text-xs text-gray-400 mt-2">（受付時間：平日 9:00〜17:00）</p>
            </div>
        </div>
    </main>

    <script>
        // 【重要】ここにGASのウェブアプリURLを貼り付けてください
        // 例: const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx.../exec";
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzxO7NAXqG1VUdMH9teFHRjz7Z8zyfyG7FC7Hm2NBO4e6vrA8w6S2GU1SGe_4ll68pU/exec"; 

        // DOMContentLoadedで初期化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded: カレンダー機能を初期化します');

            // カレンダー関連の変数
            let currentDate = new Date();
            let selectedDate = null; // 現在選択中の日付（時間帯選択用）
            let selectedTimeSlot = null; // 現在選択中の時間帯（時間帯選択用）
            let selectedDateTimes = []; // 選択した候補日時の配列（最大3つ）
            const MAX_SELECTIONS = 3;
            
            // 空き状況のモックデータ（実際の運用ではGASから取得）
            // キーは "YYYY-MM-DD" 形式、値は利用可能な時間帯の配列
            const availabilityData = {
                // 例：今日から2週間分の空き状況
            };

            // 利用可能な時間帯（1時間単位）
            const timeSlots = [
                { start: '09:00', end: '10:00', label: '9:00-10:00' },
                { start: '10:00', end: '11:00', label: '10:00-11:00' },
                { start: '11:00', end: '12:00', label: '11:00-12:00' },
                { start: '12:00', end: '13:00', label: '12:00-13:00' },
                { start: '13:00', end: '14:00', label: '13:00-14:00' },
                { start: '14:00', end: '15:00', label: '14:00-15:00' },
                { start: '15:00', end: '16:00', label: '15:00-16:00' },
                { start: '16:00', end: '17:00', label: '16:00-17:00' },
            ];

            // 日付をフォーマット（YYYY-MM-DD）
            function formatDate(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            // 日付文字列からDateオブジェクトを作成
            function parseDate(dateString) {
                const [year, month, day] = dateString.split('-').map(Number);
                return new Date(year, month - 1, day);
            }

            // その日の空き状況を取得（モックデータ、実際はGASから取得）
            function getAvailabilityForDate(dateString) {
                // 過去の日付は利用不可
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const checkDate = parseDate(dateString);
                if (checkDate < today) {
                    return [];
                }

                // 日曜日は休業
                if (checkDate.getDay() === 0) {
                    return [];
                }

                // モックデータがあればそれを使用、なければ全時間帯を利用可能とする
                if (availabilityData[dateString]) {
                    return availabilityData[dateString];
                }

                // デフォルト：平日は全時間帯利用可能
                return timeSlots.map(slot => slot.start);
            }

            // カレンダーを描画
            function renderCalendar() {
                try {
                    const currentMonthEl = document.getElementById('currentMonth');
                    const calendarDays = document.getElementById('calendarDays');
                    
                    if (!currentMonthEl || !calendarDays) {
                        console.warn('カレンダー要素が見つかりません。カレンダーセクションが表示されているか確認してください。');
                        return;
                    }
                    
                    const year = currentDate.getFullYear();
                    const month = currentDate.getMonth();
                    
                    // 月の表示を更新
                    currentMonthEl.textContent = `${year}年${month + 1}月`;

                    // カレンダーの日付部分をクリア
                    calendarDays.innerHTML = '';

            // 月の最初の日と最後の日を取得
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay()); // 週の最初の日（日曜日）

            // 6週間分の日付を表示
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'text-center py-2 relative min-h-[3rem] flex flex-col items-center justify-center';
                
                // 今月以外の日付はグレーアウト
                if (date.getMonth() !== month) {
                    dayElement.classList.add('text-gray-300');
                    const dateText = document.createElement('div');
                    dateText.className = 'text-sm';
                    dateText.textContent = date.getDate();
                    dayElement.appendChild(dateText);
                } else {
                    const dateString = formatDate(date);
                    const availability = getAvailabilityForDate(dateString);
                    const hasAvailability = availability.length > 0;
                    
                    // 日付を表示
                    const dateText = document.createElement('div');
                    dateText.className = 'text-sm mb-1';
                    dateText.textContent = date.getDate();
                    dayElement.appendChild(dateText);
                    
                    // 空き状況がある場合は丸を表示
                    if (hasAvailability) {
                        // この日に選択済みの時間帯があるかチェック
                        const selectedTimesForDate = selectedDateTimes.filter(dt => dt.date === dateString);
                        const hasSelectedTimes = selectedTimesForDate.length > 0;
                        
                        const circle = document.createElement('div');
                        if (hasSelectedTimes) {
                            // 選択済みの日は緑色の丸
                            circle.className = 'w-2 h-2 rounded-full bg-green-500';
                            // 選択済みの数を表示
                            if (selectedTimesForDate.length > 1) {
                                const countBadge = document.createElement('div');
                                countBadge.className = 'absolute -top-1 -right-1 w-4 h-4 bg-green-500 text-white text-xs rounded-full flex items-center justify-center';
                                countBadge.textContent = selectedTimesForDate.length;
                                dayElement.appendChild(countBadge);
                            }
                        } else {
                            // 未選択の日はオレンジ色の丸
                            circle.className = 'w-2 h-2 rounded-full bg-brand-cta';
                        }
                        dayElement.appendChild(circle);
                        
                        // クリック可能にする
                        dayElement.classList.add('cursor-pointer', 'hover:bg-gray-100', 'rounded', 'relative');
                        dayElement.dataset.date = dateString;
                        
                        // 現在選択中の日付のスタイル
                        if (selectedDate === dateString) {
                            dayElement.classList.remove('hover:bg-gray-100');
                            dayElement.classList.add('bg-brand-cta', 'text-white', 'rounded-full');
                            circle.classList.remove('bg-brand-cta', 'bg-green-500');
                            circle.classList.add('bg-white');
                            dateText.classList.add('text-white');
                        }
                        
                        // クリックイベント
                        dayElement.addEventListener('click', () => selectDate(dateString));
                    } else {
                        dayElement.classList.add('text-gray-300');
                    }
                }
                
                    calendarDays.appendChild(dayElement);
                }
                console.log('カレンダーを描画しました');
            } catch (error) {
                console.error('カレンダー描画エラー:', error);
            }
        }

            // 日付を選択
            function selectDate(dateString) {
                selectedDate = dateString;
                selectedTimeSlot = null;
                
                // カレンダーを再描画
                renderCalendar();
                
                // 時間帯選択を表示
                const timeSlotSection = document.getElementById('timeSlotSection');
                timeSlotSection.classList.remove('hidden');
                
                // 選択した日付を表示
                const date = parseDate(dateString);
                const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
                document.getElementById('selectedDate').textContent = 
                    `${date.getMonth() + 1}月${date.getDate()}日（${weekdays[date.getDay()]}）`;
                
                // 時間帯を表示
                renderTimeSlots(dateString);
            }

            // 時間帯を描画
            function renderTimeSlots(dateString) {
                const availability = getAvailabilityForDate(dateString);
                const timeSlotsContainer = document.getElementById('timeSlots');
                timeSlotsContainer.innerHTML = '';
                
                timeSlots.forEach(slot => {
                    const isAvailable = availability.includes(slot.start);
                    const dateTimeKey = `${dateString}_${slot.start}`;
                    const isAlreadySelected = selectedDateTimes.some(dt => dt.key === dateTimeKey);
                    
                    const slotElement = document.createElement('button');
                    slotElement.type = 'button';
                    
                    if (isAlreadySelected) {
                        // 既に選択済みの時間帯
                        slotElement.className = 'p-3 rounded-lg border-2 border-green-500 bg-green-50 text-green-700 text-sm font-medium cursor-pointer relative';
                        slotElement.innerHTML = `${slot.label} <i class="fas fa-check ml-1"></i>`;
                        slotElement.addEventListener('click', () => {
                            // 選択済みの場合は削除
                            const index = selectedDateTimes.findIndex(dt => dt.key === dateTimeKey);
                            if (index !== -1) {
                                selectedDateTimes.splice(index, 1);
                                renderSelectedDateTimes();
                                renderTimeSlots(dateString);
                                renderCalendar();
                            }
                        });
                    } else if (isAvailable) {
                        // 利用可能な時間帯
                        slotElement.className = `p-3 rounded-lg border text-sm font-medium transition ${
                            selectedTimeSlot === slot.start
                                ? 'border-brand-cta bg-brand-cta text-white'
                                : 'border-brand-cta text-brand-cta hover:bg-brand-cta hover:text-white cursor-pointer'
                        }`;
                        slotElement.textContent = slot.label;
                        slotElement.addEventListener('click', () => selectTimeSlot(dateString, slot.start, slot.end));
                    } else {
                        // 利用不可な時間帯
                        slotElement.className = 'p-3 rounded-lg border border-gray-200 text-gray-300 cursor-not-allowed text-sm font-medium';
                        slotElement.textContent = slot.label;
                        slotElement.disabled = true;
                    }
                    
                    timeSlotsContainer.appendChild(slotElement);
                });
            }

            // 時間帯を選択
            function selectTimeSlot(dateString, start, end) {
                // 既に3つ選択されている場合は追加しない
                if (selectedDateTimes.length >= MAX_SELECTIONS) {
                    const maxMessage = document.getElementById('maxSelectionsMessage');
                    if (maxMessage) {
                        maxMessage.classList.remove('hidden');
                        setTimeout(() => {
                            maxMessage.classList.add('hidden');
                        }, 3000);
                    }
                    return;
                }
                
                // 同じ日時が既に選択されていないかチェック
                const dateTimeKey = `${dateString}_${start}`;
                if (selectedDateTimes.some(dt => dt.key === dateTimeKey)) {
                    alert('この日時は既に選択されています。');
                    return;
                }
                
                const date = parseDate(dateString);
                const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
                const dateLabel = `${date.getMonth() + 1}月${date.getDate()}日（${weekdays[date.getDay()]}）`;
                const timeLabel = timeSlots.find(s => s.start === start)?.label || `${start}-${end}`;
                
                // 選択した日時を配列に追加
                selectedDateTimes.push({
                    key: dateTimeKey,
                    date: dateString,
                    time: start,
                    end: end,
                    dateLabel: dateLabel,
                    timeLabel: timeLabel,
                    displayText: `${dateLabel} ${timeLabel}`
                });
                
                // 選択した日時のリストを更新
                renderSelectedDateTimes();
                
                // 時間帯選択をリセット
                selectedDate = null;
                selectedTimeSlot = null;
                document.getElementById('timeSlotSection').classList.add('hidden');
                
                // カレンダーを再描画
                renderCalendar();
            }
            
            // 選択した日時のリストを描画
            function renderSelectedDateTimes() {
                const container = document.getElementById('selectedDateTimesList');
                if (!container) return;
                
                container.innerHTML = '';
                
                if (selectedDateTimes.length === 0) {
                    container.innerHTML = '<div class="text-xs text-gray-400">候補日時を選択してください</div>';
                    return;
                }
                
                selectedDateTimes.forEach((dateTime, index) => {
                    const item = document.createElement('div');
                    item.className = 'p-3 bg-brand-light border border-brand-main rounded-lg flex items-center justify-between';
                    item.innerHTML = `
                        <div>
                            <div class="text-xs text-gray-500">候補${index + 1}</div>
                            <div class="text-sm font-bold text-brand-main">${dateTime.displayText}</div>
                        </div>
                        <button type="button" class="text-gray-500 hover:text-red-500 transition" data-index="${index}">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    
                    // 削除ボタンのイベント
                    const deleteBtn = item.querySelector('button');
                    deleteBtn.addEventListener('click', () => {
                        selectedDateTimes.splice(index, 1);
                        renderSelectedDateTimes();
                        renderCalendar();
                    });
                    
                    container.appendChild(item);
                });
            }

            // 月を変更
            const prevMonthBtn = document.getElementById('prevMonth');
            const nextMonthBtn = document.getElementById('nextMonth');
            
            if (prevMonthBtn) {
                prevMonthBtn.addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() - 1);
                    renderCalendar();
                });
            }

            if (nextMonthBtn) {
                nextMonthBtn.addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() + 1);
                    renderCalendar();
                });
            }

            // 初期化時に選択日時リストを描画
            renderSelectedDateTimes();

            // 見学・面談希望のチェックボックス変更時の処理
            function checkCalendarVisibility() {
                const visitCheckbox = document.getElementById('typeVisit');
                const consultationCheckbox = document.getElementById('typeConsultation');
                const calendarSection = document.getElementById('calendarSection');
                
                if (!visitCheckbox || !consultationCheckbox || !calendarSection) {
                    console.error('必要なDOM要素が見つかりません');
                    return;
                }
                
                const visitChecked = visitCheckbox.checked;
                const consultationChecked = consultationCheckbox.checked;
                
                console.log('カレンダー表示チェック:', { visitChecked, consultationChecked });
                
                if (visitChecked || consultationChecked) {
                    calendarSection.classList.remove('hidden');
                    console.log('カレンダーを表示します');
                    renderCalendar();
                    renderSelectedDateTimes();
                } else {
                    calendarSection.classList.add('hidden');
                    selectedDate = null;
                    selectedTimeSlot = null;
                    selectedDateTimes = [];
                    renderSelectedDateTimes();
                }
            }

            const typeVisitCheckbox = document.getElementById('typeVisit');
            const typeConsultationCheckbox = document.getElementById('typeConsultation');
            
            if (typeVisitCheckbox) {
                typeVisitCheckbox.addEventListener('change', checkCalendarVisibility);
                console.log('typeVisit イベントリスナーを設定しました');
            } else {
                console.error('typeVisit 要素が見つかりません');
            }
            
            if (typeConsultationCheckbox) {
                typeConsultationCheckbox.addEventListener('change', checkCalendarVisibility);
                console.log('typeConsultation イベントリスナーを設定しました');
            } else {
                console.error('typeConsultation 要素が見つかりません');
            }

            const form = document.getElementById('reservationForm');
            
            if (form) {
                form.addEventListener('submit', (e) => {
                    e.preventDefault();

                    // URLが設定されていない場合のアラート
                    if (!SCRIPT_URL) {
                        alert('システム管理者へ連絡：Google Apps ScriptのURLが設定されていません。');
                        return;
                    }

                    // 見学・面談希望が選択されている場合、候補日時をチェック
                    const visitChecked = document.getElementById('typeVisit')?.checked || false;
                    const consultationChecked = document.getElementById('typeConsultation')?.checked || false;
                    if ((visitChecked || consultationChecked) && selectedDateTimes.length === 0) {
                        alert('ご希望の候補日時を少なくとも1つ選択してください。');
                        return;
                    }

                    const submitBtn = document.getElementById('submitBtn');
                    const originalBtnText = submitBtn.innerHTML;
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> 送信中...';

                    // データの整形
                    const formData = new FormData(form);
                    const data = {};
                    
                    // チェックボックスの処理
                    const checkedTypes = [];
                    document.querySelectorAll('input[name="type"]:checked').forEach(cb => checkedTypes.push(cb.value));
                    
                    data.parentName = formData.get('parentName');
                    data.childName = formData.get('childName');
                    data.childAge = formData.get('childAge');
                    data.email = formData.get('email');
                    data.tel = formData.get('tel');
                    data.certificate = formData.get('certificate');
                    data.message = formData.get('message');
                    data.requestType = checkedTypes.join(', ');
                    
                    // 選択した候補日時を追加
                    if (selectedDateTimes.length > 0) {
                        data.selectedDateTimes = selectedDateTimes.map(dt => ({
                            date: dt.date,
                            time: dt.time,
                            end: dt.end,
                            displayText: dt.displayText
                        }));
                        data.selectedDateTimesText = selectedDateTimes.map(dt => dt.displayText).join('、');
                    }
                    
                    data.formType = 'reservation';

                    // GASへ送信
                    fetch(SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors', // CORSエラー回避のためno-corsモードを使用
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    })
                    .then(() => {
                        // no-corsモードではレスポンスの中身が見れないため、エラーが起きなければ成功とみなす
                        document.getElementById('formContainer').classList.add('hidden');
                        document.getElementById('contactOptions').classList.add('hidden');
                        document.getElementById('successMessage').classList.remove('hidden');
                        window.scrollTo(0, 0);
                    })
                    .catch((error) => {
                        console.error('Error:', error);
                        alert('送信に失敗しました。');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalBtnText;
                    });
                });
            }
        }); // DOMContentLoaded終了
    </script>

    <!-- フッター -->
    <footer class="bg-gray-800 text-gray-400 py-8 text-center text-xs mt-12">
        <div class="mb-4 space-x-4">
            <a href="index.html" class="hover:text-white transition">トップページ</a>
            <span class="text-gray-600">|</span>
            <a href="recruit.html" class="hover:text-white transition">採用情報</a>
            <span class="text-gray-600">|</span>
            <a href="sitter.html" class="hover:text-white transition">ベビーシッター</a>
            <span class="text-gray-600">|</span>
            <a href="program.html" class="hover:text-white transition">支援プログラム・自己評価</a>
        </div>
        <p class="mb-2">児童発達支援 pocopoco</p>
        <p class="mb-4">〒183-0052　東京都府中市新町1丁目71番地７</p>
        <p class="mb-1">運営会社：株式会社INU</p>
        <p>&copy; 2025 pocopoco All Rights Reserved.</p>
    </footer>
</body>
</html>

